<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OrchestrationApi - 仪表板</title>

    <!-- Favicon 配置 - 添加版本号防止缓存 -->
    <link rel="icon" href="/favicon.png?v=2" type="image/png">
    <link rel="shortcut icon" href="/favicon.ico?v=2" type="image/x-icon">
    <link rel="apple-touch-icon" href="/favicon.png?v=2" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        /* 自定义极小屏幕断点支持 */
        @media (min-width: 480px) {
            .xs\:flex-row {
                flex-direction: row;
            }

            .xs\:space-y-0> :not([hidden])~ :not([hidden]) {
                --tw-space-y-reverse: 0;
                margin-top: calc(0px * calc(1 - var(--tw-space-y-reverse)));
                margin-bottom: calc(0px * var(--tw-space-y-reverse));
            }

            .xs\:space-x-2> :not([hidden])~ :not([hidden]) {
                --tw-space-x-reverse: 0;
                margin-right: calc(0.5rem * var(--tw-space-x-reverse));
                margin-left: calc(0.5rem * calc(1 - var(--tw-space-x-reverse)));
            }
        }

        /* 移动端触摸友好的按钮最小高度 */
        @media (max-width: 640px) {
            .touch-friendly {
                min-height: 44px;
            }
        }

        /* 自定义模态框动画 */
        .modal-animation {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-backdrop {
            animation: backdropFadeIn 0.3s ease-out;
        }

        @keyframes backdropFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8" x-data="multiProviderDashboard()">
        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8 space-y-4 lg:space-y-0">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                    OrchestrationApi 仪表板
                </h1>
                <p class="text-gray-600 text-sm md:text-base">管理多个AI服务商和密钥，支持自动切换实现负载均衡</p>
            </div>

            <!-- 移动端优化的按钮区域 -->
            <div class="flex flex-col space-y-3 lg:space-y-0">
                <!-- 用户信息显示 -->
                <div class="text-gray-600 text-sm text-center lg:text-right">
                    欢迎回来，<span x-text="user.username" class="font-medium text-gray-800"></span>
                    <span x-text="user.role ? `(${user.role})` : ''" class="text-gray-500"></span>
                </div>

                <!-- 响应式按钮组 -->
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 lg:gap-4">
                    <!-- 账户设置按钮 -->
                    <button @click="showUserSettingsModal = true"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center space-x-2 text-sm"
                        title="账户设置">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>账户设置</span>
                    </button>
                    <a href="/logs"
                        class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 text-center text-sm">
                        <span>请求日志</span>
                    </a>
                    <button @click="refreshData()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 text-sm">
                        <span>刷新数据</span>
                    </button>
                    <button onclick="logout()"
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 text-sm">
                        登出
                    </button>
                </div>
            </div>
        </div>

        <!-- System Overview - 第一排 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- 系统状态与运行时间 -->
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">
                                系统状态
                            </p>
                            <p class="text-xl font-bold text-green-600">
                                运行中
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-2">
                        <button @click="refreshAllHealth()" :disabled="loadingHealthRefresh"
                            class="inline-flex items-center justify-center px-2 sm:px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 transition-all duration-200">
                            <svg x-show="!loadingHealthRefresh" class="w-3 h-3 mr-1" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                </path>
                            </svg>
                            <svg x-show="loadingHealthRefresh" class="animate-spin w-3 h-3 mr-1" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span x-show="!loadingHealthRefresh">健康检查</span>
                            <span x-show="loadingHealthRefresh">检查中</span>
                        </button>
                        <button @click="loadSystemHealth()" :disabled="loadingSystemHealth"
                            class="inline-flex items-center justify-center px-2 sm:px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 transition-all duration-200">
                            <svg x-show="!loadingSystemHealth" class="w-3 h-3 mr-1" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                            <svg x-show="loadingSystemHealth" class="animate-spin w-3 h-3 mr-1" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span x-show="!loadingSystemHealth">刷新</span>
                            <span x-show="loadingSystemHealth">刷新中</span>
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">运行时间</span>
                        <span class="font-medium" x-text="formatDuration(systemHealth.uptime)">-</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">启动时间</span>
                        <span class="font-medium" x-text="formatDate(systemHealth.start_time)">-</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-500">版本信息</span>
                        <div class="flex items-center space-x-2">
                            <span class="font-medium" x-text="systemHealth.version || 'v1.0.0'">v1.0.0</span>
                            <!-- 版本更新提示 -->
                            <template x-if="versionInfo && versionInfo.hasNewVersion">
                                <button 
                                    @click="openReleaseUrl()"
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-700 bg-blue-100 border border-blue-200 rounded-md hover:bg-blue-200 transition-colors duration-200"
                                    :title="`有新版本 ${versionInfo.latestVersion} 可用`">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    新版本
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 服务商分组 -->
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">
                                服务商分组
                            </p>
                            <p class="text-xl font-bold text-blue-600" x-text="systemHealth.total_groups || 0"></p>
                        </div>
                    </div>
                    <button @click="loadProviderStatuses()" :disabled="loadingProviderStatuses"
                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 transition-all duration-200">
                        <svg x-show="!loadingProviderStatuses" class="w-3 h-3 mr-1" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <svg x-show="loadingProviderStatuses" class="animate-spin w-3 h-3 mr-1" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <span x-show="!loadingProviderStatuses">刷新</span>
                        <span x-show="loadingProviderStatuses">刷新中</span>
                    </button>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">启用分组</span>
                        <span class="font-medium text-green-600" x-text="systemHealth.enabled_groups || 0">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">禁用分组</span>
                        <span class="font-medium text-red-600" x-text="systemHealth.disabled_groups || 0">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">总密钥数</span>
                        <span class="font-medium" x-text="systemHealth.total_keys || 0">0</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- API密钥状态 - 第二排 -->
        <div class="mb-8">
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2h4zm-6 2v6h4V9H9z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-lg font-semibold text-gray-800">
                                API密钥状态
                            </p>
                            <p class="text-sm text-gray-500" x-show="keyStatus.last_updated">
                                更新于
                                <span x-text="keyStatus.last_updated"></span>
                            </p>
                            <p class="text-sm text-gray-400" x-show="!keyStatus.last_updated">
                                点击"手动检测"获取最新状态
                            </p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="refreshKeyStatus()" :disabled="loadingKeyStatus"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 transition-all duration-200">
                            <svg x-show="!loadingKeyStatus" class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                            <svg x-show="loadingKeyStatus" class="animate-spin w-4 h-4 mr-2" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span x-show="!loadingKeyStatus">实时状态</span>
                            <span x-show="loadingKeyStatus">获取中...</span>
                        </button>
                        <button @click="loadPersistedValidationStatus()" :disabled="loadingValidation"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-all duration-200">
                            <svg x-show="!loadingValidation" class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <svg x-show="loadingValidation" class="animate-spin w-4 h-4 mr-2" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span x-show="!loadingValidation">检查所有密钥</span>
                            <span x-show="loadingValidation">检查中...</span>
                        </button>
                    </div>
                </div>

                <!-- 密钥统计 -->
                <div class="grid grid-cols-3 gap-8">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <div class="w-6 h-6 bg-green-500 rounded-full"></div>
                        </div>
                        <div class="text-2xl font-bold text-green-600 mb-1" x-text="keyStatus.total_valid || 0">
                            0
                        </div>
                        <div class="text-sm text-gray-500">有效密钥</div>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <div class="w-6 h-6 bg-red-500 rounded-full"></div>
                        </div>
                        <div class="text-2xl font-bold text-red-600 mb-1" x-text="keyStatus.total_invalid || 0">
                            0
                        </div>
                        <div class="text-sm text-gray-500">无效密钥</div>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <div class="w-6 h-6 bg-gray-500 rounded-full"></div>
                        </div>
                        <div class="text-2xl font-bold text-gray-600 mb-1" x-text="keyStatus.total_keys || 0">
                            0
                        </div>
                        <div class="text-sm text-gray-500">总计</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Provider Groups Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 space-y-4 lg:space-y-0">
                <h2 class="text-xl font-bold">服务商分组状态</h2>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-2">
                    <button @click="openCreateGroupModal()"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>添加分组</span>
                    </button>
                    <button @click="exportGroups()"
                        class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span>导出配置</span>
                    </button>

                    <button @click="showImportModal = true"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10">
                            </path>
                        </svg>
                        <span>导入配置</span>
                    </button>
                    <!-- <button @click="refreshProviderHealth()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <span>刷新健康状态</span>
                    </button> -->
                    <button @click="clearInvalidKeys()" :disabled="clearingInvalidKeys"
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-show="clearingInvalidKeys" class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <svg x-show="!clearingInvalidKeys" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        <span x-show="!clearingInvalidKeys">清除无效密钥</span>
                        <span x-show="clearingInvalidKeys">处理中...</span>
                    </button>
                    <button @click="clearEmptyGroups()" :disabled="clearingEmptyGroups"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 sm:px-4 rounded-lg transition duration-200 flex items-center justify-center text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-show="clearingEmptyGroups" class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <svg x-show="!clearingEmptyGroups" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 13h6m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span x-show="!clearingEmptyGroups">清除空白分组</span>
                        <span x-show="clearingEmptyGroups">处理中...</span>
                    </button>

                </div>
            </div>

            <!-- 密钥状态图例 -->
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">密钥状态图例：</span>
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">有效</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">无效</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-xs text-gray-600">未检测</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 搜索和筛选 -->
            <div class="mb-6 flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" x-model="providerSearchQuery" @input="filterProviders()"
                            placeholder="搜索分组名称、服务商类型或Base URL..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <select x-model="providerStatusFilter" @change="filterProviders()"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有状态</option>
                        <option value="healthy">健康</option>
                        <option value="unhealthy">异常</option>
                    </select>
                    <select x-model="providerTypeFilter" @change="filterProviders()"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有类型</option>
                        <option value="openai">OpenAI</option>
                        <option value="gemini">Google Gemini</option>
                        <!-- <option value="azure_openai">Azure OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="openrouter">OpenRouter</option> -->
                    </select>
                    <select x-model="providerEnabledFilter" @change="filterProviders()"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有状态</option>
                        <option value="enabled">启用</option>
                        <option value="disabled">禁用</option>
                    </select>
                </div>
            </div>

            <!-- 服务商列表 -->
            <div class="space-y-3">
                <template x-for="(provider, groupId) in paginatedProviders" :key="groupId">
                    <div class="border rounded-lg p-3 hover:shadow-md transition-shadow"
                        :class="getProviderCardClass(provider)">
                        <!-- 移动端优化的响应式布局 -->
                        <div
                            class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
                            <!-- 左侧信息区 -->
                            <div
                                class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 flex-1 min-w-0">
                                <!-- 第一行：基本信息 -->
                                <div class="flex items-center space-x-3 min-w-0">
                                    <input type="checkbox" :value="groupId" x-model="selectedGroups"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0" />
                                    <div class="w-3 h-3 rounded-full flex-shrink-0"
                                        :class="provider.healthy ? 'bg-green-500' : 'bg-red-500'"></div>
                                    <div class="min-w-0 flex-1">
                                        <h3 class="font-semibold text-gray-900 truncate" x-text="provider.group_name">
                                        </h3>
                                        <!-- <p class="text-sm text-gray-500 truncate" x-text="groupId"></p> -->
                                        <p class="text-xs text-gray-400 truncate" x-text="provider.base_url || '未设置'"></p>
                                    </div>
                                    <span class="text-xs px-2 py-1 rounded-full flex-shrink-0"
                                        :class="getProviderTypeClass(provider.provider_type)"
                                        x-text="provider.provider_type.toUpperCase()"></span>
                                </div>

                                <!-- 第二行：状态信息 - 移动端换行显示 -->
                                <div
                                    class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 text-sm">
                                    <!-- 启用状态 -->
                                    <div class="flex items-center space-x-1">
                                        <span class="text-gray-600">状态:</span>
                                        <span :class="provider.enabled !== false ? 'text-green-600' : 'text-gray-500'"
                                            x-text="provider.enabled !== false ? '启用' : '禁用'"></span>
                                    </div>

                                    <!-- 密钥统计 -->
                                    <div class="flex items-center space-x-1">
                                        <span class="text-gray-600">密钥:</span>
                                        <div class="flex items-center space-x-2 flex-wrap">
                                            <!-- 总计 -->
                                            <span class="text-gray-900 font-medium"
                                                x-text="getKeyStatusData(groupId, provider).total"></span>

                                            <!-- 有效密钥 -->
                                            <div class="flex items-center space-x-1">
                                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                                <span class="text-green-600 text-xs font-medium"
                                                    x-text="getKeyStatusData(groupId, provider).valid"></span>
                                            </div>

                                            <!-- 无效密钥 -->
                                            <div class="flex items-center space-x-1"
                                                x-show="getKeyStatusData(groupId, provider).invalid > 0">
                                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                                <span class="text-red-600 text-xs font-medium"
                                                    x-text="getKeyStatusData(groupId, provider).invalid"></span>
                                            </div>

                                            <!-- 未检测 -->
                                            <div class="flex items-center space-x-1"
                                                x-show="getKeyStatusData(groupId, provider).unknown > 0">
                                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                                <span class="text-gray-500 text-xs font-medium"
                                                    x-text="getKeyStatusData(groupId, provider).unknown"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 操作按钮区 - 优化PC端和移动端响应式布局 -->
                            <div
                                class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:items-center md:space-x-2 lg:space-x-3 xl:space-x-4 flex-shrink-0">
                                <!-- 在小屏幕保持两行布局，在MD以上合并为一行 -->
                                <!-- 检测按钮 -->
                                <button @click="validateGroupKeys(groupId, provider)"
                                    :disabled="validatingGroups[groupId]"
                                    class="inline-flex items-center justify-center px-3 py-2 border border-purple-300 text-sm font-medium rounded text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 transition-colors touch-friendly whitespace-nowrap">
                                    <svg x-show="!validatingGroups[groupId]" class="w-4 h-4 sm:mr-1.5" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <svg x-show="validatingGroups[groupId]" class="animate-spin w-4 h-4 sm:mr-1.5"
                                        fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                    <span x-show="!validatingGroups[groupId]">检测</span>
                                    <span x-show="validatingGroups[groupId]">检测中</span>
                                </button>

                                <!-- 使用统计按钮 -->
                                <button @click="showKeyUsageStats(groupId, provider)"
                                    class="inline-flex items-center justify-center px-3 py-2 border border-indigo-300 text-sm font-medium rounded text-indigo-700 bg-indigo-50 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors touch-friendly whitespace-nowrap">
                                    <svg class="w-4 h-4 sm:mr-1.5" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                        </path>
                                    </svg>
                                    <span>使用统计</span>
                                </button>

                                <!-- 编辑按钮 -->
                                <button @click="editGroup(groupId, provider)"
                                    class="inline-flex items-center justify-center px-3 py-2 border border-transparent text-sm font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors touch-friendly whitespace-nowrap">
                                    <svg class="w-4 h-4 sm:mr-1.5" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                        </path>
                                    </svg>
                                    <span>编辑</span>
                                </button>

                                <!-- 启用/禁用按钮 -->
                                <button @click="toggleGroup(groupId, provider)"
                                    class="inline-flex items-center justify-center px-3 py-2 text-sm font-medium rounded transition-colors touch-friendly whitespace-nowrap"
                                    :class="provider.enabled !== false ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'">
                                    <svg class="w-4 h-4 sm:mr-1.5" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path x-show="provider.enabled !== false" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="2"
                                            d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        <path x-show="provider.enabled === false" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="2"
                                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                        </path>
                                    </svg>
                                    <span x-text="provider.enabled !== false ? '禁用' : '启用'"></span>
                                </button>

                                <!-- 删除按钮 -->
                                <button @click="deleteGroup(groupId, provider)"
                                    class="inline-flex items-center justify-center px-3 py-2 border border-transparent text-sm font-medium rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors touch-friendly whitespace-nowrap">
                                    <svg class="w-4 h-4 sm:mr-1.5" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                    <span>删除</span>
                                </button>

                            </div>
                        </div>

                        <!-- 错误信息 -->
                        <div x-show="provider.last_error"
                            class="mt-3 p-2 bg-red-100 border border-red-200 rounded text-sm text-red-700">
                            <strong>错误:</strong>
                            <span x-text="provider.last_error"></span>
                        </div>
                    </div>
                </template>

                <!-- 空状态 -->
                <div x-show="Object.keys(filteredProviders).length === 0" class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">
                        没有找到匹配的服务商
                    </h3>
                    <p class="mt-1 text-sm text-gray-500">
                        尝试调整搜索条件或筛选器
                    </p>
                </div>
            </div>

            <!-- 分页控制 -->
            <div x-show="totalProviderPages > 1" class="mt-6 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    显示 <span x-text="providerPageOffset + 1"></span>-<span
                        x-text="Math.min(providerPageOffset + providersPerPage, Object.keys(filteredProviders).length)"></span>
                    共
                    <span x-text="Object.keys(filteredProviders).length"></span>
                    个分组
                </div>
                <div class="flex space-x-1">
                    <button @click="providerPage = Math.max(1, providerPage - 1)" :disabled="providerPage <= 1"
                        class="px-3 py-2 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                        上一页
                    </button>
                    <span class="px-3 py-2 text-sm border-t border-b"
                        x-text="providerPage + ' / ' + totalProviderPages"></span>
                    <button @click="providerPage = Math.min(totalProviderPages, providerPage + 1)"
                        :disabled="providerPage >= totalProviderPages"
                        class="px-3 py-2 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                        下一页
                    </button>
                </div>
            </div>
        </div>

        <!-- Provider Models -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">支持的模型</h2>
                <div class="flex space-x-2">
                    <select x-model="selectedProvider" @change="loadProviderModels()"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有服务商</option>
                        <template x-for="(provider, groupId) in providerStatuses" :key="groupId">
                            <option :value="groupId" x-text="provider.group_name"></option>
                        </template>
                    </select>
                    <button @click="loadProviderModels()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        加载模型
                    </button>
                </div>
            </div>

            <div x-show="loadingModels" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">加载模型中...</p>
            </div>

            <div x-show="!loadingModels && Object.keys(providerModels).length > 0" class="space-y-4">
                <template x-for="(models, groupId) in providerModels" :key="groupId">
                    <div class="border rounded-lg p-4">
                        <h3 class="font-semibold text-gray-900 mb-3"
                            x-text="models.group_name + ' (' + models.provider_type + ')'"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            <template x-for="model in (models.models && models.models.data ? models.models.data : [])"
                                :key="model.id">
                                <div class="bg-gray-100 px-3 py-2 rounded text-sm">
                                    <span class="font-mono" x-text="model.id"></span>
                                    <span x-show="model.alias_name" class="text-gray-500 ml-2"
                                        x-text="'(别名: ' + model.alias_name + ')'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <div x-show="!loadingModels && Object.keys(providerModels).length === 0"
                class="text-center py-8 text-gray-500">
                <p>暂无模型数据，请选择服务商并点击加载模型</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-6">快速操作</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button @click="showProxyKeyModal = true; loadProxyKeys()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    代理密钥管理
                </button>
                <button @click="exportHealthReport()"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    导出健康报告
                </button>
                <button @click="viewSystemLogs()"
                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    查看请求日志
                </button>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                最后更新: <span x-text="formatDate(lastUpdate)"></span>
            </div>
        </div>

        <!-- Group Management Modal -->
        <div x-show="showCreateGroupModal || showEditGroupModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
            @click.self="closeGroupModal()" 
            @keydown.escape.window="closeGroupModal()">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col"
                @click.stop>
                <!-- 头部 -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900"
                                x-text="showCreateGroupModal ? '添加服务商分组' : '编辑服务商分组'"></h3>
                            <p class="text-sm text-gray-500"
                                x-text="showCreateGroupModal ? '配置新的API服务商分组' : '修改现有服务商分组配置'"></p>
                        </div>
                    </div>
                    <button @click="closeGroupModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 内容区域 -->
                <div class="flex-1 overflow-y-auto p-6">
                    <form id="groupForm" @submit.prevent="submitGroupForm()" class="space-y-8">
                        <!-- 基本信息区域 -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="text-lg font-semibold text-gray-900">
                                    基本信息
                                </h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">分组ID *</label>
                                    <input type="text" x-model="groupFormData.group_id" :disabled="showEditGroupModal"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required placeholder="如: openai-group" />
                                    <p class="text-xs text-gray-500 mt-1">
                                        唯一标识符，创建后不可修改
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">分组名称 *</label>
                                    <input type="text" x-model="groupFormData.name"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required placeholder="如: OpenAI 官方" />
                                    <p class="text-xs text-gray-500 mt-1">
                                        用于显示的友好名称
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 服务商配置区域 -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="text-lg font-semibold text-gray-900">
                                    服务商配置
                                </h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">服务商类型 *</label>
                                    <select x-model="groupFormData.provider_type" @change="onProviderTypeChange()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required>
                                        <option value="">
                                            请选择服务商类型
                                        </option>
                                        <option value="openai">
                                            OpenAI
                                        </option>
                                        <option value="gemini">
                                            Google Gemini
                                        </option>
                                        <!-- <option value="azure_openai">
                                                Azure OpenAI
                                            </option>
                                            <option value="anthropic">
                                                Anthropic
                                            </option>
                                            <option value="openrouter">
                                                OpenRouter
                                            </option> -->
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">
                                        选择API服务商类型
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Base URL *</label>
                                    <input type="url" x-model="groupFormData.base_url"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required placeholder="如: https://api.openai.com/v1" />
                                    <p class="text-xs text-gray-500 mt-1">
                                        API服务的基础URL地址
                                    </p>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">启用状态</label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" x-model="groupFormData.enabled"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
                                        <span class="text-sm text-gray-700">启用此分组</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">
                                        禁用后该分组将不会处理请求
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 配置参数区域 -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="flex items-center space-x-2 mb-6">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
                                    </path>
                                </svg>
                                <h4 class="text-lg font-semibold text-gray-900">
                                    配置参数
                                </h4>
                            </div>
                            <!-- 基础配置 -->
                            <div class="mb-6">
                                <h5 class="text-sm font-medium text-gray-800 mb-4 flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    基础配置
                                </h5>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <svg class="w-4 h-4 inline mr-1 text-orange-500" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            超时时间（秒）
                                        </label>
                                        <input type="number" x-model="groupFormData.timeout"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            min="1" max="600" placeholder="30" />
                                        <p class="text-xs text-gray-500 mt-2">
                                            请求超时时间，建议30-120秒
                                        </p>
                                    </div>

                                    <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <svg class="w-4 h-4 inline mr-1 text-red-500" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                                </path>
                                            </svg>
                                            最大重试次数
                                        </label>
                                        <input type="number" x-model="groupFormData.max_retries"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            min="0" max="10" placeholder="3" />
                                        <p class="text-xs text-gray-500 mt-2">
                                            失败后的重试次数，建议1-5次
                                        </p>
                                    </div>

                                    <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <svg class="w-4 h-4 inline mr-1 text-green-500" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                                </path>
                                            </svg>
                                            轮换策略
                                        </label>
                                        <select x-model="groupFormData.rotation_strategy"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="round_robin">
                                                轮询 (Round Robin)
                                            </option>
                                            <option value="random">
                                                随机 (Random)
                                            </option>
                                            <option value="least_used">
                                                最少使用 (Least Used)
                                            </option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-2">
                                            多个密钥时的选择策略
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- RPM限制配置和测试模型配置 -->
                            <div class="mb-6">
                                <h5 class="text-sm font-medium text-gray-800 mb-4 flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    高级配置
                                </h5>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">RPM限制</label>
                                        <input type="number" x-model="groupFormData.rpm_limit" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="0" />
                                        <p class="text-xs text-gray-500 mt-2">
                                            每分钟请求数限制，0表示无限制
                                        </p>
                                    </div>

                                    <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">测试模型（用于密钥检测）</label>
                                        <input type="text" x-model="groupFormData.test_model"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="例如：gpt-3.5-turbo 或 gemini-1.5-flash" />
                                        <p class="text-xs text-gray-500 mt-2">
                                            用于验证API密钥可用性的模型ID，留空则按分组模型或默认模型验证
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- 代理配置 -->
                            <div class="mb-6">
                                <h5 class="text-sm font-medium text-gray-800 mb-4 flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                                    </svg>
                                    代理配置
                                </h5>
                                <div class="space-y-4">
                                    <!-- 启用代理开关 -->
                                    <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                        <label class="flex items-center space-x-3">
                                            <input type="checkbox" x-model="groupFormData.proxy_enabled"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <span class="text-sm font-medium text-gray-700">
                                                启用代理
                                            </span>
                                        </label>
                                        <p class="text-xs text-gray-500 mt-2">
                                            启用后，该分组的所有API请求将通过配置的代理服务器发送
                                        </p>
                                    </div>

                                    <!-- 代理设置（仅在启用代理时显示） -->
                                    <div x-show="groupFormData.proxy_enabled" class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    代理类型
                                                </label>
                                                <select x-model="groupFormData.proxy_config.type"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <option value="http">HTTP</option>
                                                    <option value="https">HTTPS</option>
                                                    <option value="socks5">SOCKS5</option>
                                                </select>
                                            </div>

                                            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    代理主机 *
                                                </label>
                                                <input type="text" x-model="groupFormData.proxy_config.host"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    placeholder="127.0.0.1 或 proxy.example.com" />
                                            </div>

                                            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    代理端口 *
                                                </label>
                                                <input type="number" x-model="groupFormData.proxy_config.port"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    min="1" max="65535" placeholder="8080" />
                                            </div>

                                            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    用户名（可选）
                                                </label>
                                                <input type="text" x-model="groupFormData.proxy_config.username"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    placeholder="代理认证用户名" />
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    密码（可选）
                                                </label>
                                                <input type="password" x-model="groupFormData.proxy_config.password"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    placeholder="代理认证密码" />
                                            </div>

                                            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                <label class="flex items-center space-x-3">
                                                    <input type="checkbox" x-model="groupFormData.proxy_config.bypass_local"
                                                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                    <span class="text-sm font-medium text-gray-700">
                                                        绕过本地地址
                                                    </span>
                                                </label>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    本地地址（127.0.0.1, localhost等）不使用代理
                                                </p>
                                            </div>
                                        </div>

                                        <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                绕过域名列表（可选）
                                            </label>
                                            <textarea x-model="groupFormData.proxy_bypass_domains_text" rows="3"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                placeholder="每行一个域名，例如：&#10;example.com&#10;*.internal.com&#10;192.168.*"></textarea>
                                            <p class="text-xs text-gray-500 mt-2">
                                                这些域名的请求不会通过代理，支持通配符（*）
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 高级选项 -->
                            <!-- <div>
                                    <h5
                                        class="text-sm font-medium text-gray-800 mb-4 flex items-center"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2 text-purple-500"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                                            ></path>
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                            ></path>
                                        </svg>
                                        高级选项
                                    </h5>
                                    <div
                                        class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"
                                    >
                                        <label
                                            class="flex items-start space-x-3 cursor-pointer"
                                        >
                                            <input
                                                type="checkbox"
                                                x-model="groupFormData.use_native_response"
                                                class="mt-1 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                            />
                                            <div>
                                                <span
                                                    class="text-sm font-medium text-gray-700"
                                                    >使用原生接口响应</span
                                                >
                                                <p
                                                    class="text-xs text-gray-500 mt-1"
                                                >
                                                    勾选后将返回服务商的原生响应格式，而不是OpenAI兼容格式
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div> -->
                        </div>

                        <!-- API密钥区域 -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2h4zm-6 2v6h4V9H9z">
                                        </path>
                                    </svg>
                                    <h4 class="text-lg font-semibold text-gray-900">
                                        API密钥管理
                                    </h4>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" @click="showBatchAddModal = true"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        批量添加
                                    </button>
                                    <button type="button" @click="addGroupApiKey()"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        添加密钥
                                    </button>
                                    <button type="button" @click="clearAllKeys()"
                                        :disabled="groupFormData.api_keys.filter(k => k.trim()).length === 0"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                        清空密钥
                                    </button>
                                    <button type="button" @click="exportKeys()"
                                        :disabled="groupFormData.api_keys.filter(k => k.trim()).length === 0"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                        导出密钥
                                    </button>
                                    <button type="button" @click="deleteInvalidKeys()" x-show="getInvalidKeyCount() > 0"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                        删除失效密钥 (<span x-text="getInvalidKeyCount()"></span>)
                                    </button>
                                    <button type="button" @click="bulkDeleteInvalidKeysFromServer()"
                                        x-show="showEditGroupModal && editingGroupId"
                                        :disabled="bulkDeletingInvalidKeys"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                        <svg x-show="!bulkDeletingInvalidKeys" class="w-4 h-4 mr-1" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                        <svg x-show="bulkDeletingInvalidKeys" class="animate-spin w-4 h-4 mr-1"
                                            fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                            </path>
                                        </svg>
                                        <span x-show="!bulkDeletingInvalidKeys">一键删除失效密钥</span>
                                        <span x-show="bulkDeletingInvalidKeys">删除中...</span>
                                    </button>
                                    <button type="button" @click="deleteSelectedKeys()" x-show="selectedKeys.length > 0"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                        删除选中 (<span x-text="selectedKeys.length"></span>)
                                    </button>
                                    <button type="button" @click="removeDuplicateKeys()"
                                        x-show="checkCurrentKeyDuplicates().size > 0"
                                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        去除重复
                                    </button>
                                </div>
                            </div>

                            <!-- 密钥列表 -->
                            <div class="border rounded-md max-h-60 overflow-y-auto">
                                <div class="space-y-1 p-2">
                                    <template x-for="(key, index) in paginatedKeys" :key="index + keyPageOffset">
                                        <div class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded"
                                            :class="getKeyValidationClass(index + keyPageOffset) + (checkCurrentKeyDuplicates().has(index + keyPageOffset) ? ' border-l-4 border-orange-400 bg-orange-50' : '')">
                                            <input type="checkbox" :value="index + keyPageOffset" x-model="selectedKeys"
                                                class="rounded" />
                                            <div class="flex-1 relative">
                                                <input type="text"
                                                    x-model="groupFormData.api_keys[index + keyPageOffset]"
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                    placeholder="输入API密钥" />
                                                <!-- 验证状态指示器 -->
                                                <div
                                                    class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                                                    <!-- 有效状态 -->
                                                    <div x-show="keyValidationStatus[index + keyPageOffset] === 'valid'"
                                                        class="flex items-center" title="密钥有效">
                                                        <svg class="w-4 h-4 text-green-500" fill="currentColor"
                                                            viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd"
                                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                                clip-rule="evenodd"></path>
                                                        </svg>
                                                    </div>
                                                    <!-- 无效状态 -->
                                                    <div x-show="keyValidationStatus[index + keyPageOffset] === 'invalid'"
                                                        class="flex items-center" title="密钥无效">
                                                        <svg class="w-4 h-4 text-red-500" fill="currentColor"
                                                            viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd"
                                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                                                clip-rule="evenodd"></path>
                                                        </svg>
                                                    </div>
                                                    <!-- 验证中状态 -->
                                                    <div x-show="keyValidationStatus[index + keyPageOffset] === 'validating'"
                                                        class="flex items-center" title="验证中">
                                                        <svg class="w-4 h-4 text-yellow-500 animate-spin" fill="none"
                                                            viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10"
                                                                stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor"
                                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                            </path>
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 强制设置密钥状态按钮 -->
                                            <div class="flex items-center space-x-1">
                                                <button type="button"
                                                    @click="forceSetKeyStatus(index + keyPageOffset, 'valid')"
                                                    :disabled="forcingKeyStatus[index + keyPageOffset]"
                                                    class="text-green-600 hover:text-green-800 p-1 rounded"
                                                    title="强制设为有效"
                                                    x-show="keyValidationStatus[index + keyPageOffset] !== 'valid'">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd"
                                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                            clip-rule="evenodd"></path>
                                                    </svg>
                                                </button>
                                                <button type="button"
                                                    @click="forceSetKeyStatus(index + keyPageOffset, 'invalid')"
                                                    :disabled="forcingKeyStatus[index + keyPageOffset]"
                                                    class="text-red-600 hover:text-red-800 p-1 rounded" title="强制设为无效"
                                                    x-show="keyValidationStatus[index + keyPageOffset] !== 'invalid'">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd"
                                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                                            clip-rule="evenodd"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <button type="button" @click="removeGroupApiKey(index + keyPageOffset)"
                                                class="text-red-500 hover:text-red-700 p-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>

                                <!-- 分页控制 -->
                                <div x-show="groupFormData.api_keys.length > keysPerPage"
                                    class="border-t p-2 flex justify-between items-center bg-gray-50">
                                    <div class="text-sm text-gray-600">
                                        显示
                                        <span x-text="keyPageOffset + 1"></span>-<span
                                            x-text="Math.min(keyPageOffset + keysPerPage, groupFormData.api_keys.length)"></span>
                                        共
                                        <span x-text="groupFormData.api_keys.length"></span>
                                        个密钥
                                    </div>
                                    <div class="flex space-x-1">
                                        <button type="button" @click="keyPage = Math.max(1, keyPage - 1)"
                                            :disabled="keyPage <= 1"
                                            class="px-2 py-1 text-sm border rounded disabled:opacity-50">
                                            上一页
                                        </button>
                                        <button type="button" @click="keyPage = Math.min(totalKeyPages, keyPage + 1)"
                                            :disabled="keyPage >= totalKeyPages"
                                            class="px-2 py-1 text-sm border rounded disabled:opacity-50">
                                            下一页
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 支持的模型 -->
                        <div class="md:col-span-2 mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">
                                    支持的模型（可选）
                                </h4>
                                <div class="flex space-x-2">
                                    <button type="button" @click="loadAvailableModels()"
                                        :disabled="!groupFormData.provider_type || !groupFormData.base_url || groupFormData.api_keys.filter(k => k.trim()).length === 0"
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50">
                                        <span x-show="!loadingModels">加载模型</span>
                                        <span x-show="loadingModels">加载中...</span>
                                    </button>
                                    <button type="button" @click="selectAllModels()" x-show="availableModels.length > 0"
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                        全选
                                    </button>
                                    <button type="button" @click="clearAllModels()"
                                        x-show="groupFormData.models.length > 0"
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">
                                        清空
                                    </button>
                                </div>
                            </div>

                            <!-- 模型选择器 -->
                            <div x-show="availableModels.length > 0" class="border rounded-md p-3 bg-gray-50 mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="text-sm text-gray-600">
                                        从API加载的可用模型：
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        显示
                                        <span x-text="filteredModels.length"></span>
                                        /
                                        <span x-text="availableModels.length"></span>
                                        个模型
                                    </div>
                                </div>

                                <!-- 搜索框 -->
                                <div class="mb-3">
                                    <div class="relative">
                                        <input type="text" x-model="modelSearchQuery" @input="filterModels()"
                                            placeholder="搜索模型名称..."
                                            class="w-full px-3 py-2 pl-8 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        <svg class="absolute left-2 top-2.5 h-4 w-4 text-gray-400" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                        <button x-show="modelSearchQuery" @click="clearModelSearch()"
                                            class="absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- 模型列表 -->
                                <div class="max-h-40 overflow-y-auto space-y-1">
                                    <template x-for="model in filteredModels" :key="model.id">
                                        <label class="flex items-center space-x-2 text-sm hover:bg-white p-1 rounded">
                                            <input type="checkbox" :value="model.id" x-model="groupFormData.models"
                                                @change="syncModelsToText"
                                                class="rounded" />
                                            <span class="font-mono" x-text="model.id"></span>
                                            <span x-show="model.owned_by" class="text-gray-500"
                                                x-text="'(' + model.owned_by + ')'"></span>
                                        </label>
                                    </template>
                                    <div x-show="filteredModels.length === 0 && modelSearchQuery"
                                        class="text-center py-4 text-gray-500 text-sm">
                                        未找到匹配的模型
                                    </div>
                                </div>
                            </div>

                            <!-- 手动输入模型 -->
                            <div>
                                <div class="text-sm text-gray-600 mb-2">
                                    或手动输入模型名称：
                                </div>
                                <textarea x-model="modelsText"
                                    @input="syncTextToModels"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="3" placeholder="每行一个模型名称，留空表示支持所有模型"></textarea>
                                <p class="text-sm text-gray-500 mt-1">
                                    每行输入一个模型名称，如：gpt-3.5-turbo
                                </p>
                            </div>

                            <!-- 已选择的模型预览 -->
                            <div x-show="groupFormData.models.length > 0" class="mt-3">
                                <div class="text-sm text-gray-600 mb-2">
                                    已选择的模型 (<span x-text="groupFormData.models.length"></span>)：
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="model in groupFormData.models" :key="model">
                                        <span
                                            class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">
                                            <span x-text="model"></span>
                                            <button type="button" @click="removeModel(model)"
                                                class="ml-1 text-blue-600 hover:text-blue-800">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- 模型重命名配置 -->
                        <div class="md:col-span-2 mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">
                                    模型重命名配置（可选）
                                </h4>
                                <div class="flex items-center space-x-2">
                                    <button type="button" @click="showPasteModelMappingModal = true"
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                            </path>
                                        </svg>
                                        批量粘贴
                                    </button>
                                    <button type="button" @click="showModelMappingHelp = !showModelMappingHelp"
                                        class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- 帮助信息 -->
                            <div x-show="showModelMappingHelp" x-collapse
                                class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
                                <p class="mb-2">
                                    <strong>模型重命名功能说明：</strong>
                                </p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>
                                        可以为该分组的模型设置别名，统一不同分组的模型名称
                                    </li>
                                    <li>
                                        客户端使用别名请求时，系统会自动转换为实际的模型名称
                                    </li>
                                    <li>
                                        例如：将"gpt-4-turbo"重命名为"gpt-4"，客户端可以统一使用"gpt-4"
                                    </li>
                                    <li>
                                        支持多个别名映射到同一个实际模型
                                    </li>
                                    <li class="text-blue-600">
                                        <strong>跨分组映射：</strong>不同分组可以使用相同的别名，系统会自动选择可用的分组
                                    </li>
                                    <li class="text-orange-600">
                                        <strong>同分组限制：</strong>同一分组内，一个别名只能映射到一个模型
                                    </li>
                                </ul>
                            </div>

                            <!-- 模型映射列表 -->
                            <div class="space-y-2">
                                <template x-for="(mapping, index) in modelMappings" :key="index">
                                    <div class="flex items-center space-x-2 p-2 border border-gray-200 rounded-md">
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-500 mb-1">别名（客户端使用）</label>
                                            <div class="relative" x-data="{ showAliasDropdown: false, filteredAliases: [] }"
                                                x-init="
                                                    filteredAliases = [...(allConfiguredAliases || [])].sort();
                                                    $watch('mapping.alias', value => {
                                                        if (value) {
                                                            filteredAliases = [...(allConfiguredAliases || [])].filter(a => a.toLowerCase().includes(value.toLowerCase())).sort();
                                                        } else {
                                                            filteredAliases = [...(allConfiguredAliases || [])].sort();
                                                        }
                                                    });
                                                ">
                                                <input type="text" x-model="mapping.alias" @input="showAliasDropdown = true"
                                                    @focus="showAliasDropdown = true" @blur="setTimeout(() => showAliasDropdown = false, 200)"
                                                    :class="getDuplicateAliasClass(mapping.alias, index)"
                                                    placeholder="输入或选择别名，例如: gpt-4" autocomplete="off">
                                                <button type="button" @click="showAliasDropdown = !showAliasDropdown"
                                                    class="absolute right-1 top-1 p-1 text-gray-400 hover:text-gray-600">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                            d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </button>
                                                <div x-show="showAliasDropdown && filteredAliases.length > 0" x-cloak
                                                    class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto">
                                                    <template x-for="alias in filteredAliases.slice(0, 50)" :key="alias">
                                                        <div @click="mapping.alias = alias; showAliasDropdown = false"
                                                            class="px-3 py-2 text-sm cursor-pointer hover:bg-blue-50 hover:text-blue-600"
                                                            :class="{ 'bg-blue-100 text-blue-600': mapping.alias === alias }"
                                                            x-text="alias"></div>
                                                    </template>
                                                    <div x-show="filteredAliases.length > 50"
                                                        class="px-3 py-2 text-xs text-gray-500 border-t">
                                                        显示前50个结果，输入更多字符以缩小范围
                                                    </div>
                                                </div>
                                            </div>
                                            <div x-show="isDuplicateAlias(mapping.alias, index)"
                                                class="text-xs text-orange-600 mt-1">
                                                ⚠️ 此别名在当前分组中已存在
                                            </div>
                                        </div>
                                        <div class="text-gray-400 flex items-center justify-center mt-6">→</div>
                                        <div class="flex-1">
                                            <label class="block text-xs text-gray-500 mb-1">实际模型名称</label>
                                            <select x-model="mapping.original" @change="suggestAliasFromSimilarity(mapping)"
                                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                                <option value="">
                                                    请选择模型
                                                </option>
                                                <template x-for="model in groupFormData.models" :key="model">
                                                    <option :value="model" :selected="model === mapping.original"
                                                        x-text="model"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <button type="button" @click="removeModelMapping(index)"
                                            class="text-red-500 hover:text-red-700 p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>

                                <!-- 添加新映射按钮 -->
                                <button type="button" @click="addModelMapping()"
                                    class="w-full py-2 px-4 border-2 border-dashed border-gray-300 rounded-md text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    添加模型重命名
                                </button>
                            </div>
                        </div>

                        <!-- JSON请求参数覆盖 -->
                        <div class="md:col-span-2 mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">
                                    JSON请求参数覆盖（可选）
                                </h4>
                                <button type="button" @click="showRequestParamsHelp = !showRequestParamsHelp"
                                    class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                        </path>
                                    </svg>
                                </button>
                            </div>

                            <!-- 帮助信息 -->
                            <div x-show="showRequestParamsHelp" x-collapse
                                class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
                                <p class="mb-2">
                                    <strong>JSON请求参数覆盖功能说明：</strong>
                                </p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>
                                        可以为该分组设置默认的请求参数，这些参数会覆盖客户端发送的参数
                                    </li>
                                    <li>
                                        支持的参数：temperature（温度）、max_tokens（最大token数）、top_p、stop（停止词）
                                    </li>
                                    <li>
                                        示例：{"temperature": 0.7,
                                        "max_tokens": 1000, "top_p": 0.9}
                                    </li>
                                    <li>
                                        留空表示不覆盖任何参数，使用客户端发送的原始参数
                                    </li>
                                </ul>
                            </div>

                            <!-- JSON编辑器 -->
                            <div>
                                <textarea x-model="requestParamsText" @input="validateRequestParams()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                    rows="6"
                                    placeholder='{"temperature": 0.7, "max_tokens": 1000, "top_p": 0.9, "stop": ["Human:", "AI:"]}'></textarea>
                                <p class="text-sm text-gray-500 mt-1">
                                    请输入有效的JSON格式，留空表示不覆盖任何参数
                                </p>
                            </div>

                            <!-- JSON验证状态 -->
                            <div x-show="requestParamsValidationMessage" class="mt-2">
                                <div :class="requestParamsValidationError ? 'text-red-600' : 'text-green-600'"
                                    class="text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path x-show="requestParamsValidationError" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        <path x-show="!requestParamsValidationError" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span x-text="requestParamsValidationMessage"></span>
                                </div>
                            </div>
                        </div>

                        <!-- JSON请求头覆盖 -->
                        <div class="md:col-span-2 mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">
                                    JSON请求头覆盖（可选）
                                </h4>
                                <button type="button" @click="showHeadersHelp = !showHeadersHelp"
                                    class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                            <!-- 帮助信息 -->
                            <div x-show="showHeadersHelp" x-collapse
                                class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
                                <p class="mb-2">
                                    <strong>JSON请求头覆盖功能说明：</strong>
                                </p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>
                                        可以为该分组设置额外的请求头，这些请求头会添加到API请求中
                                    </li>
                                    <li>
                                        支持自定义请求头：User-Agent、Referer、X-Custom-Header等
                                    </li>
                                    <li>
                                        示例：{"User-Agent": "MyApp/1.0", "X-Custom-Header": "custom-value"}
                                    </li>
                                    <li>
                                        留空表示不添加任何自定义请求头
                                    </li>
                                </ul>
                            </div>
                            <!-- JSON编辑器 -->
                            <div>
                                <textarea x-model="headersText" @input="validateHeaders()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                    rows="6"
                                    placeholder='{"User-Agent": "MyApp/1.0", "X-Custom-Header": "custom-value", "Referer": "https://example.com"}'></textarea>
                                <p class="text-sm text-gray-500 mt-1">
                                    请输入有效的JSON格式，留空表示不添加任何自定义请求头
                                </p>
                            </div>
                            <!-- JSON验证状态 -->
                            <div x-show="headersValidationMessage" class="mt-2">
                                <div :class="headersValidationError ? 'text-red-600' : 'text-green-600'"
                                    class="text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path x-show="headersValidationError" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        <path x-show="!headersValidationError" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span x-text="headersValidationMessage"></span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- 底部操作 -->
                <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 rounded-b-lg">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <span x-show="showCreateGroupModal">填写完整信息后点击创建</span>
                            <span x-show="showEditGroupModal">修改完成后点击更新保存</span>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" @click="closeGroupModal()"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                取消
                            </button>
                            <button type="submit" form="groupForm" :disabled="submittingGroup"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <svg x-show="submittingGroup" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span x-show="!submittingGroup" x-text="showCreateGroupModal ? '创建分组' : '更新分组'"></span>
                                <span x-show="submittingGroup">处理中...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paste Model Mapping Modal -->
        <div x-show="showPasteModelMappingModal" x-cloak x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="showPasteModelMappingModal = false">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">批量粘贴模型重命名配置</h3>
                    <button @click="closePasteModelMappingModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        JSON格式的模型映射配置
                    </label>
                    <div class="mb-2 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700">
                        <p class="mb-2"><strong>格式说明：</strong></p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>JSON对象格式，key为新名字（别名），value为原始名字</li>
                            <li>例如：<code>{"gemini-2.5-flash-image-preview": "google/gemini-2.5-flash-image-preview:free"}</code>
                            </li>
                            <li>系统将自动解析并添加到当前分组的模型重命名列表中</li>
                        </ul>
                    </div>
                    <textarea x-model="pasteModelMappingText" @input="validatePasteModelMapping()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                        rows="10" placeholder='{
  "gemini-2.5-flash-image-preview": "google/gemini-2.5-flash-image-preview:free",
  "deepseek-chat-v3.1": "deepseek/deepseek-chat-v3.1:free",
  "qwen3-coder": "qwen/qwen3-coder:free",
  "kimi-vl-a3b-thinking": "moonshotai/kimi-vl-a3b-thinking:free"
}'></textarea>

                    <!-- 验证状态 -->
                    <div x-show="pasteModelMappingValidationMessage" class="mt-2">
                        <div :class="pasteModelMappingValidationError ? 'text-red-600' : 'text-green-600'"
                            class="text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path x-show="pasteModelMappingValidationError" stroke-linecap="round"
                                    stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                <path x-show="!pasteModelMappingValidationError" stroke-linecap="round"
                                    stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span x-text="pasteModelMappingValidationMessage"></span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" @click="closePasteModelMappingModal()"
                        class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        取消
                    </button>
                    <button type="button" @click="applyPasteModelMapping()"
                        :disabled="pasteModelMappingValidationError || !pasteModelMappingText.trim()"
                        class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        确定
                    </button>
                </div>
            </div>
        </div>

        <!-- Batch Add Keys Modal -->
        <div x-show="showBatchAddModal" x-cloak x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="showBatchAddModal = false">
            <div class="bg-white rounded-lg p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">批量添加API密钥</h3>
                    <button @click="showBatchAddModal = false" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">API密钥列表</label>
                    <textarea x-model="batchKeysText"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        rows="8"
                        placeholder="每行输入一个API密钥&#10;支持以下格式：&#10;sk-1234567890abcdef&#10;your-api-key-here&#10;&#10;空行将被忽略"></textarea>
                    <p class="text-sm text-gray-500 mt-1">
                        每行输入一个API密钥，空行将被自动忽略
                    </p>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" @click="showBatchAddModal = false"
                        class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                        取消
                    </button>
                    <button type="button" @click="addBatchKeys()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                        添加密钥
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Groups Modal -->
        <div x-show="showImportModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            @click.self="showImportModal = false" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        导入分组配置
                    </h3>
                </div>

                <div class="px-6 py-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            选择配置文件 (JSON格式)
                        </label>
                        <input type="file" accept=".json" @change="handleFileSelect"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                    </div>

                    <div class="text-sm text-gray-600">
                        <p class="mb-2">注意事项：</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>仅支持JSON格式的配置文件</li>
                            <li>导入的分组将覆盖同名的现有分组</li>
                            <li>请确保配置文件格式正确</li>
                        </ul>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button @click="showImportModal = false"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition duration-200">
                        取消
                    </button>
                    <button @click="importGroups()" :disabled="!selectedFile || importing"
                        class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-md transition duration-200">
                        <span x-show="!importing">导入</span>
                        <span x-show="importing">导入中...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Proxy Key Management Modal -->
        <div x-show="showProxyKeyModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            @click.self="showProxyKeyModal = false" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                <!-- 头部 -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">
                                代理服务 API 密钥
                            </h3>
                            <p class="text-sm text-gray-500">
                                管理用于访问代理服务的API密钥
                            </p>
                        </div>
                    </div>
                    <button @click="showProxyKeyModal = false"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 内容 -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- 操作栏 -->
                    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <!-- 生成新密钥按钮 -->
                        <button @click="showGenerateProxyKeyForm = true"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                            生成新密钥
                        </button>

                        <!-- 手动刷新按钮 - 图标样式 -->
                        <button @click="refreshProxyKeysOnly()"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 p-2 rounded-lg transition duration-200"
                            title="手动刷新使用次数">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </button>

                        <!-- 搜索框、排序和页面大小选择 -->
                        <div class="flex flex-col sm:flex-row gap-2">
                            <!-- 搜索框 -->
                            <div class="relative">
                                <input type="text" x-model="proxyKeySearch" @input="searchProxyKeys()"
                                    @keyup.enter="searchProxyKeys()" placeholder="搜索密钥名称、描述或密钥..."
                                    class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <button x-show="proxyKeySearch" @click="clearProxyKeySearch()"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <svg class="h-4 w-4 text-gray-400 hover:text-gray-600" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- 排序选择 -->
                            <select x-model="proxyKeySortBy" @change="changeProxyKeySortBy()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="created_time_desc">创建时间 ↓</option>
                                <option value="created_time_asc">创建时间 ↑</option>
                                <option value="usage_count_desc">使用次数 ↓</option>
                                <option value="usage_count_asc">使用次数 ↑</option>
                                <option value="name_asc">名称 A-Z</option>
                                <option value="name_desc">名称 Z-A</option>
                            </select>

                            <!-- 页面大小选择 -->
                            <select x-model="proxyKeyPageSize" @change="changeProxyKeyPageSize()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="5">5条/页</option>
                                <option value="10">10条/页</option>
                                <option value="20">20条/页</option>
                                <option value="50">50条/页</option>
                            </select>
                        </div>
                    </div>

                    <!-- 生成密钥表单 -->
                    <div x-show="showGenerateProxyKeyForm" x-cloak
                        class="mb-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="text-lg font-medium mb-6 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2h4zm-6 2v6h4V9H9z">
                                </path>
                            </svg>
                            生成新的代理密钥
                        </h4>

                        <!-- 基本信息 -->
                        <div class="mb-6">
                            <h5 class="text-sm font-medium text-gray-800 mb-3">
                                基本信息
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">密钥名称 *</label>
                                    <input type="text" x-model="newProxyKey.name" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="输入密钥名称" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                                    <input type="text" x-model="newProxyKey.description"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="输入描述信息" />
                                </div>
                            </div>
                        </div>

                        <!-- 分组权限 -->
                        <div class="mb-6">
                            <h5 class="text-sm font-medium text-gray-800 mb-3">
                                分组权限
                            </h5>
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-3">允许访问的分组</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                                    <template x-for="(provider, groupId) in providerStatuses" :key="groupId">
                                        <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                            <input type="checkbox" :value="groupId"
                                                :checked="newProxyKey.allowed_groups.includes(groupId)"
                                                @change="toggleProxyKeyGroup(groupId, $event.target.checked)"
                                                class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                            <span class="text-sm" x-text="provider.group_name"></span>
                                        </label>
                                    </template>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    不选择任何分组表示可以访问所有分组
                                </p>
                            </div>
                        </div>

                        <!-- 分组间请求设置 -->
                        <div x-show="newProxyKey.allowed_groups.length > 1 || newProxyKey.allowed_groups.length === 0"
                            class="mb-6">
                            <h5 class="text-sm font-medium text-gray-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l3 3-3 3m5 0h3"></path>
                                </svg>
                                分组间请求设置
                            </h5>
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">选择策略</label>
                                    <select x-model="newProxyKey.group_selection_config.strategy"
                                        @change="onNewProxyKeyStrategyChange()"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="round_robin">
                                            轮询 (Round Robin) -
                                            在分组间轮流分配请求
                                        </option>
                                        <option value="weighted">
                                            权重 (Weighted) -
                                            根据权重比例分配请求
                                        </option>
                                        <option value="random">
                                            随机 (Random) - 随机选择分组
                                        </option>
                                        <option value="failover">
                                            故障转移 (Failover) -
                                            按优先级顺序选择
                                        </option>
                                    </select>
                                </div>

                                <!-- 权重配置 -->
                                <div x-show="newProxyKey.group_selection_config.strategy === 'weighted'" class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-3">分组权重配置</label>
                                    <div class="space-y-2">
                                        <template
                                            x-for="groupId in getGroupsForWeightConfig(newProxyKey.allowed_groups)"
                                            :key="groupId">
                                            <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded">
                                                <span class="text-sm font-medium min-w-0 flex-1"
                                                    x-text="getGroupName(groupId)"></span>
                                                <div class="flex items-center space-x-2">
                                                    <label class="text-xs text-gray-600">权重:</label>
                                                    <input type="number" :value="getGroupWeight(groupId)"
                                                        @input="setGroupWeight(groupId, $event.target.value)" min="1"
                                                        max="100"
                                                        class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" />
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        权重越高，获得的请求越多。例如权重3:1的分组将获得约75%:25%的请求分配。
                                    </p>
                                </div>

                                <!-- 故障转移优先级配置 -->
                                <div x-show="newProxyKey.group_selection_config.strategy === 'failover'" class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-3">分组优先级配置</label>
                                    <div class="space-y-2">
                                        <template
                                            x-for="groupId in getGroupsForWeightConfig(newProxyKey.allowed_groups)"
                                            :key="groupId">
                                            <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded">
                                                <span class="text-sm font-medium min-w-0 flex-1"
                                                    x-text="getGroupName(groupId)"></span>
                                                <div class="flex items-center space-x-2">
                                                    <label class="text-xs text-gray-600">优先级:</label>
                                                    <input type="number" :value="getGroupWeight(groupId)"
                                                        @input="setGroupWeight(groupId, $event.target.value)" min="1"
                                                        max="10"
                                                        class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" />
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        数字越小优先级越高。优先使用优先级最高的分组，当该分组不可用时转移到下一优先级。
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-2">
                            <button @click="generateProxyKey()"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                生成密钥
                            </button>
                            <button @click="showGenerateProxyKeyForm = false; resetProxyKeyForm()"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md">
                                取消
                            </button>
                        </div>
                    </div>

                    <!-- 密钥列表 -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        密钥
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        名称/描述
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        分组配置
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        请求次数
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        创建时间
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        操作
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="key in proxyKeys" :key="key.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <code class="text-sm font-mono bg-gray-100 px-2 py-1 rounded"
                                                    x-text="key.key.substring(0, 20) + '...'"></code>
                                                <button @click="copyToClipboard(key.key)"
                                                    class="ml-2 text-gray-400 hover:text-gray-600">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                                        </path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="mt-1">
                                                <template x-if="key.allowed_groups && key.allowed_groups.length > 0">
                                                    <div class="flex flex-wrap gap-1">
                                                        <template x-for="groupId in key.allowed_groups" :key="groupId">
                                                            <span
                                                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                                                x-text="getGroupName(groupId)"></span>
                                                        </template>
                                                    </div>
                                                </template>
                                                <template x-if="!key.allowed_groups || key.allowed_groups.length === 0">
                                                    <span
                                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">所有分组</span>
                                                </template>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900" x-text="key.name"></div>
                                            <div class="text-sm text-gray-500" x-text="key.description"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <!-- 分组选择配置显示 -->
                                            <template x-if="key.allowed_groups && key.allowed_groups.length > 1">
                                                <div class="text-sm">
                                                    <div class="flex items-center space-x-2 mb-1">
                                                        <span class="text-xs font-medium text-gray-600">策略:</span>
                                                        <span
                                                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                            :class="getStrategyBadgeClass(key.group_selection_config?.strategy || 'round_robin')"
                                                            x-text="getStrategyDisplayName(key.group_selection_config?.strategy || 'round_robin')"></span>
                                                    </div>
                                                    <template
                                                        x-if="key.group_selection_config?.strategy === 'weighted' && key.group_selection_config?.group_weights">
                                                        <div class="text-xs text-gray-500">
                                                            <template
                                                                x-for="weight in key.group_selection_config.group_weights"
                                                                :key="weight.group_id">
                                                                <div class="flex justify-between">
                                                                    <span x-text="getGroupName(weight.group_id)"></span>
                                                                    <span x-text="'权重: ' + weight.weight"></span>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                            <template x-if="key.allowed_groups && key.allowed_groups.length === 1">
                                                <span class="text-xs text-gray-400">单分组</span>
                                            </template>
                                            <template x-if="!key.allowed_groups || key.allowed_groups.length === 0">
                                                <span class="text-xs text-gray-500">所有分组</span>
                                            </template>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                            x-text="key.usage_count || 0"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                            x-text="formatDate(key.created_at)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button @click="editProxyKey(key)"
                                                class="text-indigo-600 hover:text-indigo-900 mr-3">
                                                编辑
                                            </button>
                                            <button @click="deleteProxyKey(key.id)"
                                                class="text-red-600 hover:text-red-900">
                                                删除
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="proxyKeys.length === 0">
                                    <tr>
                                        <td colspan="6"
                                            class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                            <template x-if="proxyKeySearch.trim()">
                                                <span>未找到匹配的代理密钥</span>
                                            </template>
                                            <template x-if="!proxyKeySearch.trim()">
                                                <span>暂无代理密钥</span>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页控件 -->
                    <div x-show="proxyKeyPagination.total > 0"
                        class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <!-- 分页信息 -->
                        <div class="text-sm text-gray-700">
                            显示第
                            <span class="font-medium"
                                x-text="((proxyKeyPagination.page - 1) * proxyKeyPagination.page_size + 1)"></span>
                            到
                            <span class="font-medium"
                                x-text="Math.min(proxyKeyPagination.page * proxyKeyPagination.page_size, proxyKeyPagination.total)"></span>
                            条，共
                            <span class="font-medium" x-text="proxyKeyPagination.total"></span>
                            条记录
                        </div>

                        <!-- 分页按钮 -->
                        <div class="flex items-center space-x-2">
                            <!-- 上一页 -->
                            <button @click="goToProxyKeyPage(proxyKeyPagination.page - 1)"
                                :disabled="!proxyKeyPagination.has_prev"
                                :class="proxyKeyPagination.has_prev ? 'text-gray-500 hover:text-gray-700' : 'text-gray-300 cursor-not-allowed'"
                                class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md">
                                上一页
                            </button>

                            <!-- 页码 -->
                            <template x-for="page in Array.from({length: Math.min(5, proxyKeyPagination.total_pages)}, (_, i) => {
                                const start = Math.max(1, proxyKeyPagination.page - 2);
                                const end = Math.min(proxyKeyPagination.total_pages, start + 4);
                                const adjustedStart = Math.max(1, end - 4);
                                return adjustedStart + i;
                            }).filter(p => p <= proxyKeyPagination.total_pages)" :key="page">
                                <button @click="goToProxyKeyPage(page)"
                                    :class="page === proxyKeyPagination.page ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:text-gray-700'"
                                    class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md">
                                    <span x-text="page"></span>
                                </button>
                            </template>

                            <!-- 下一页 -->
                            <button @click="goToProxyKeyPage(proxyKeyPagination.page + 1)"
                                :disabled="!proxyKeyPagination.has_next"
                                :class="proxyKeyPagination.has_next ? 'text-gray-500 hover:text-gray-700' : 'text-gray-300 cursor-not-allowed'"
                                class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md">
                                下一页
                            </button>
                        </div>
                    </div>

                    <!-- 编辑代理密钥模态框 -->
                    <div x-show="showEditProxyKeyModal" x-cloak
                        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-10 mx-auto p-6 border max-w-4xl shadow-lg rounded-lg bg-white">
                            <div class="mt-3">
                                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                        </path>
                                    </svg>
                                    编辑代理密钥
                                </h3>
                                <form @submit.prevent="updateProxyKey()" class="space-y-6">
                                    <!-- 基本信息 -->
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-800 mb-4">
                                            基本信息
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">密钥名称
                                                    *</label>
                                                <input type="text" x-model="editingProxyKey.name" required
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                    placeholder="输入密钥名称" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                                                <input type="text" x-model="editingProxyKey.description"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                    placeholder="输入描述信息" />
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <label class="flex items-center">
                                                <input type="checkbox" x-model="editingProxyKey.is_active"
                                                    class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                                <span class="ml-2 text-sm font-medium text-gray-700">启用密钥</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- 分组权限 -->
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-800 mb-4">
                                            分组权限
                                        </h4>
                                        <div class="bg-white rounded-lg border border-gray-200 p-3">
                                            <label class="block text-sm font-medium text-gray-700 mb-3">允许访问的分组</label>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                                                <template x-for="(provider, groupId) in providerStatuses"
                                                    :key="groupId">
                                                    <label
                                                        class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                                        <input type="checkbox" :value="groupId"
                                                            :checked="editingProxyKey.allowed_groups.includes(groupId)"
                                                            @change="toggleEditingProxyKeyGroup(groupId, $event.target.checked)"
                                                            class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                                        <span class="text-sm" x-text="provider.group_name"></span>
                                                    </label>
                                                </template>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2">
                                                不选择任何分组表示可以访问所有分组
                                            </p>
                                        </div>
                                    </div>

                                    <!-- 分组间请求设置 -->
                                    <div x-show="editingProxyKey.allowed_groups.length > 1 || editingProxyKey.allowed_groups.length === 0"
                                        class="bg-gray-50 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-800 mb-4 flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 9l3 3-3 3m5 0h3"></path>
                                            </svg>
                                            分组间请求设置
                                        </h4>
                                        <div class="bg-white rounded-lg border border-gray-200 p-3">
                                            <div class="mb-4">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">选择策略</label>
                                                <select x-model="editingProxyKey.group_selection_config.strategy"
                                                    @change="onEditingProxyKeyStrategyChange()"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                                    <option value="round_robin">
                                                        轮询 (Round Robin) -
                                                        在分组间轮流分配请求
                                                    </option>
                                                    <option value="weighted">
                                                        权重 (Weighted) -
                                                        根据权重比例分配请求
                                                    </option>
                                                    <option value="random">
                                                        随机 (Random) -
                                                        随机选择分组
                                                    </option>
                                                    <option value="failover">
                                                        故障转移 (Failover)
                                                        - 按优先级顺序选择
                                                    </option>
                                                </select>
                                            </div>

                                            <!-- 权重配置 -->
                                            <div x-show="editingProxyKey.group_selection_config.strategy === 'weighted'"
                                                class="mt-4">
                                                <label
                                                    class="block text-sm font-medium text-gray-700 mb-3">分组权重配置</label>
                                                <div class="space-y-2">
                                                    <template
                                                        x-for="groupId in getGroupsForWeightConfig(editingProxyKey.allowed_groups)"
                                                        :key="groupId">
                                                        <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded">
                                                            <span class="text-sm font-medium min-w-0 flex-1"
                                                                x-text="getGroupName(groupId)"></span>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="text-xs text-gray-600">权重:</label>
                                                                <input type="number"
                                                                    :value="getEditingGroupWeight(groupId)"
                                                                    @input="setEditingGroupWeight(groupId, $event.target.value)"
                                                                    min="1" max="100"
                                                                    class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" />
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    权重越高，获得的请求越多。例如权重3:1的分组将获得约75%:25%的请求分配。
                                                </p>
                                            </div>

                                            <!-- 故障转移优先级配置 -->
                                            <div x-show="editingProxyKey.group_selection_config.strategy === 'failover'"
                                                class="mt-4">
                                                <label
                                                    class="block text-sm font-medium text-gray-700 mb-3">分组优先级配置</label>
                                                <div class="space-y-2">
                                                    <template
                                                        x-for="groupId in getGroupsForWeightConfig(editingProxyKey.allowed_groups)"
                                                        :key="groupId">
                                                        <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded">
                                                            <span class="text-sm font-medium min-w-0 flex-1"
                                                                x-text="getGroupName(groupId)"></span>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="text-xs text-gray-600">优先级:</label>
                                                                <input type="number"
                                                                    :value="getEditingGroupWeight(groupId)"
                                                                    @input="setEditingGroupWeight(groupId, $event.target.value)"
                                                                    min="1" max="10"
                                                                    class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" />
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    数字越小优先级越高。优先使用优先级最高的分组，当该分组不可用时转移到下一优先级。
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex space-x-2 pt-4 border-t border-gray-200">
                                        <button type="submit"
                                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-md flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            更新密钥
                                        </button>
                                        <button type="button" @click="closeEditProxyKeyModal()"
                                            class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md">
                                            取消
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Usage Statistics Modal -->
        <div x-show="showKeyUsageStatsModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">密钥使用统计</h3>
                            <p class="text-sm text-gray-500" x-show="currentGroupUsageStats">
                                分组: <span x-text="currentGroupUsageStats?.group_name"></span>
                                | 负载策略: <span x-text="currentGroupUsageStats?.balance_policy"></span>
                            </p>
                        </div>
                    </div>
                    <button @click="closeKeyUsageStatsModal()"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div x-show="loadingUsageStats" class="flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <span class="ml-2 text-gray-600">加载中...</span>
                    </div>

                    <div x-show="!loadingUsageStats && currentGroupUsageStats" class="space-y-6">
                        <!-- Statistics Summary -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600"
                                        x-text="currentGroupUsageStats?.total_keys || 0"></div>
                                    <div class="text-sm text-gray-500">总密钥数</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600"
                                        x-text="(currentGroupUsageStats?.key_stats || []).filter(k => k.is_available).length">
                                    </div>
                                    <div class="text-sm text-gray-500">可用密钥</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600"
                                        x-text="(currentGroupUsageStats?.key_stats || []).reduce((sum, k) => sum + k.usage_count, 0)">
                                    </div>
                                    <div class="text-sm text-gray-500">总使用次数</div>
                                </div>
                            </div>
                        </div>

                        <!-- Key Statistics Table -->
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h4 class="text-lg font-semibold text-gray-900">密钥详细统计</h4>
                                <button @click="resetGroupUsageStats(currentGroupUsageStats.group_id)"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
                                    重置统计
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                密钥</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                使用次数</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                最后使用</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                状态</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="keyStats in currentGroupUsageStats?.key_stats || []"
                                            :key="keyStats.api_key_hash">
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <div class="text-sm font-medium text-gray-900"
                                                            x-text="keyStats.api_key_prefix"></div>
                                                        <div class="text-xs text-gray-500 ml-2"
                                                            x-text="'#' + keyStats.api_key_hash"></div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900" x-text="keyStats.usage_count">
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900"
                                                        x-text="keyStats.last_used ? new Date(keyStats.last_used).toLocaleString() : '从未使用'">
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span
                                                        class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                        :class="keyStats.is_available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                        <span x-text="keyStats.is_available ? '可用' : '不可用'"></span>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button @click="openForceUpdateModal(keyStats)"
                                                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                                                        强制更新
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div x-show="!loadingUsageStats && !currentGroupUsageStats" class="text-center py-8">
                        <div class="text-gray-500">无法加载使用统计数据</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Force Update Key Status Modal -->
        <div x-show="showForceUpdateModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900">强制更新密钥状态</h3>
                    <button @click="closeForceUpdateModal()"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="p-6">
                    <div x-show="selectedForceUpdateKey" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">目标密钥</label>
                            <div class="p-3 bg-gray-50 rounded border">
                                <div class="text-sm font-medium" x-text="selectedForceUpdateKey?.api_key_prefix"></div>
                                <div class="text-xs text-gray-500"
                                    x-text="'Hash: ' + selectedForceUpdateKey?.api_key_hash"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">新状态</label>
                            <select x-model="forceUpdateStatus"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="valid">有效 (valid)</option>
                                <option value="invalid">无效 (invalid)</option>
                            </select>
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button @click="submitForceUpdate()"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">
                                确认更新
                            </button>
                            <button @click="closeForceUpdateModal()"
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Settings Modal -->
        <div x-show="showUserSettingsModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto"
            @click.self="showUserSettingsModal = false" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0">
            <div
                class="bg-white rounded-lg p-4 sm:p-6 w-full max-w-md shadow-xl my-4 sm:my-0 min-h-0 max-h-screen overflow-y-auto">
                <!-- 标题区域 - 移动端优化 -->
                <div
                    class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 space-y-2 sm:space-y-0">
                    <div class="flex-1">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-900">账户设置</h3>
                        <p class="text-xs sm:text-sm text-gray-500">修改您的用户名和密码</p>
                    </div>
                    <button @click="closeUserSettingsModal()"
                        class="self-end sm:self-center p-1 text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form @submit.prevent="updateUserInfo()" class="space-y-4">
                    <!-- 当前密码 -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            当前密码 <span class="text-red-500">*</span>
                        </label>
                        <input type="password" x-model="userForm.currentPassword"
                            class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                            placeholder="请输入当前密码" required>
                    </div>

                    <!-- 新用户名 -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            新用户名
                        </label>
                        <input type="text" x-model="userForm.newUsername" :placeholder="`当前: ${user.username}`"
                            class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                        <p class="text-xs text-gray-500">留空则不修改用户名</p>
                    </div>

                    <!-- 新密码 -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            新密码
                        </label>
                        <input type="password" x-model="userForm.newPassword"
                            class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                            placeholder="留空则不修改密码" minlength="6">
                        <p class="text-xs text-gray-500">密码长度至少6位</p>
                    </div>

                    <!-- 确认新密码 -->
                    <div x-show="userForm.newPassword" class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            确认新密码 <span class="text-red-500">*</span>
                        </label>
                        <input type="password" x-model="userForm.confirmPassword"
                            class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
                            placeholder="请再次输入新密码" :required="userForm.newPassword">
                    </div>

                    <!-- 按钮区域 - 移动端优化 -->
                    <div
                        class="flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-3 mt-6 pt-4 border-t border-gray-200">
                        <button type="button" @click="closeUserSettingsModal()"
                            class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition duration-200 order-2 sm:order-1">
                            取消
                        </button>
                        <button type="submit" :disabled="updatingUserInfo"
                            class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-md transition duration-200 order-1 sm:order-2">
                            <span x-show="!updatingUserInfo">保存修改</span>
                            <span x-show="updatingUserInfo">保存中...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div x-show="message" x-cloak x-transition class="fixed top-4 right-4 z-50">
            <div class="px-4 py-2 rounded-md text-white"
                :class="messageType === 'success' ? 'bg-green-500' : 'bg-red-500'">
                <span x-text="message"></span>
            </div>
        </div>
    </div>

    <!-- 自定义确认框模态 -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden modal-backdrop">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white modal-animation">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">确认操作</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 whitespace-pre-line" id="confirmMessage"></p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button id="confirmYes" 
                            class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-20 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 transition-colors">
                        确定
                    </button>
                    <button id="confirmNo" 
                            class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-20 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义提示框模态 -->
    <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden modal-backdrop">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white modal-animation">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full" id="alertIcon">
                    <!-- 图标将通过 JavaScript 动态设置 -->
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="alertTitle">提示</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-600 whitespace-pre-line" id="alertMessage"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="alertOk" 
                            class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-20 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors">
                        确定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 自定义确认框函数
        function showConfirm(message, title = '确认操作') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const messageEl = document.getElementById('confirmMessage');
                const titleEl = modal.querySelector('h3');
                const yesBtn = document.getElementById('confirmYes');
                const noBtn = document.getElementById('confirmNo');
                
                messageEl.textContent = message;
                titleEl.textContent = title;
                modal.classList.remove('hidden');
                
                // 添加淡入动画
                setTimeout(() => {
                    modal.querySelector('.relative').style.transform = 'scale(1)';
                    modal.querySelector('.relative').style.opacity = '1';
                }, 10);
                
                const handleYes = () => {
                    modal.classList.add('hidden');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    document.removeEventListener('keydown', handleKeydown);
                    resolve(true);
                };
                
                const handleNo = () => {
                    modal.classList.add('hidden');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    document.removeEventListener('keydown', handleKeydown);
                    resolve(false);
                };
                
                const handleKeydown = (e) => {
                    if (e.key === 'Enter') {
                        handleYes();
                    } else if (e.key === 'Escape') {
                        handleNo();
                    }
                };
                
                yesBtn.addEventListener('click', handleYes);
                noBtn.addEventListener('click', handleNo);
                document.addEventListener('keydown', handleKeydown);
                
                // 点击遮罩关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        handleNo();
                    }
                });
            });
        }

        // 自定义提示框函数
        function showAlert(message, type = 'info', title = '提示') {
            return new Promise((resolve) => {
                const modal = document.getElementById('alertModal');
                const messageEl = document.getElementById('alertMessage');
                const titleEl = document.getElementById('alertTitle');
                const iconEl = document.getElementById('alertIcon');
                const okBtn = document.getElementById('alertOk');
                
                messageEl.textContent = message;
                titleEl.textContent = title;
                
                // 根据类型设置图标和颜色
                let iconHTML = '';
                let buttonClass = 'bg-blue-500 hover:bg-blue-600 focus:ring-blue-300';
                
                switch (type) {
                    case 'success':
                        iconHTML = `
                            <div class="bg-green-100 rounded-full p-3">
                                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>`;
                        buttonClass = 'bg-green-500 hover:bg-green-600 focus:ring-green-300';
                        break;
                    case 'error':
                        iconHTML = `
                            <div class="bg-red-100 rounded-full p-3">
                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>`;
                        buttonClass = 'bg-red-500 hover:bg-red-600 focus:ring-red-300';
                        break;
                    case 'warning':
                        iconHTML = `
                            <div class="bg-yellow-100 rounded-full p-3">
                                <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>`;
                        buttonClass = 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-300';
                        break;
                    default: // info
                        iconHTML = `
                            <div class="bg-blue-100 rounded-full p-3">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>`;
                }
                
                iconEl.innerHTML = iconHTML;
                okBtn.className = `px-4 py-2 text-white text-base font-medium rounded-md w-20 focus:outline-none transition-colors ${buttonClass}`;
                
                modal.classList.remove('hidden');
                
                // 添加淡入动画
                setTimeout(() => {
                    modal.querySelector('.relative').style.transform = 'scale(1)';
                    modal.querySelector('.relative').style.opacity = '1';
                }, 10);
                
                const handleOk = () => {
                    modal.classList.add('hidden');
                    okBtn.removeEventListener('click', handleOk);
                    document.removeEventListener('keydown', handleKeydown);
                    resolve();
                };
                
                const handleKeydown = (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        handleOk();
                    }
                };
                
                okBtn.addEventListener('click', handleOk);
                document.addEventListener('keydown', handleKeydown);
                
                // 点击遮罩关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        handleOk();
                    }
                });
            });
        }

        function multiProviderDashboard() {
            return {
                systemHealth: {
                    status: "healthy",
                    total_groups: 0,
                    healthy_groups: 0,
                    total_keys: 0,
                    active_keys: 0,
                    uptime: 0,
                },
                versionInfo: null,
                checkingVersion: false,
                providerStatuses: {},
                providerModels: {},
                selectedProvider: "",
                loadingModels: false,
                lastUpdate: new Date(),

                // 用户信息管理相关
                user: {
                    username: '',
                    role: ''
                },
                showUserSettingsModal: false,
                updatingUserInfo: false,
                userForm: {
                    currentPassword: '',
                    newUsername: '',
                    newPassword: '',
                    confirmPassword: ''
                },

                // 分组导出相关
                selectedGroups: [],

                // 分组导入相关
                showImportModal: false,
                selectedFile: null,
                importing: false,

                // 密钥状态相关
                keyStatus: {
                    total_keys: 0,
                    total_valid: 0,
                    total_invalid: 0,
                    last_updated: null,
                    groups: {},
                },

                // 代理密钥管理相关
                showProxyKeyModal: false,
                showGenerateProxyKeyForm: false,
                showEditProxyKeyModal: false,
                proxyKeys: [],
                newProxyKey: {
                    name: "",
                    description: "",
                    allowed_groups: [],
                    group_selection_config: {
                        strategy: "round_robin",
                        group_weights: [],
                    },
                },
                editingProxyKey: {
                    id: "",
                    name: "",
                    description: "",
                    is_active: true,
                    allowed_groups: [],
                    group_selection_config: {
                        strategy: "round_robin",
                        group_weights: [],
                    },
                },
                // 策略权重快照（切换策略时恢复此前填写的值）
                newProxyKeyWeightsSnapshot: {},
                editingProxyKeyWeightsSnapshot: {},
                _newProxyKeyPrevStrategy: "round_robin",
                _editingProxyKeyPrevStrategy: "round_robin",
                // 代理密钥分页、搜索和排序
                proxyKeySearch: "",
                proxyKeySortBy: "created_time_desc", // 默认按创建时间倒序
                proxyKeyPage: 1,
                proxyKeyPageSize: 10,
                proxyKeyPagination: {
                    page: 1,
                    page_size: 10,
                    total: 0,
                    total_pages: 0,
                    has_prev: false,
                    has_next: false,
                },
                loadingKeyStatus: false,
                loadingValidation: false,
                loadingSystemHealth: false,
                loadingProviderStatuses: false,
                loadingHealthRefresh: false,
                keyStatusTimer: null,

                // 密钥使用统计相关
                showKeyUsageStatsModal: false,
                currentGroupUsageStats: null,
                loadingUsageStats: false,
                selectedForceUpdateKey: null,
                showForceUpdateModal: false,
                forceUpdateStatus: 'valid',

                // 服务商筛选和分页
                providerSearchQuery: "",
                providerStatusFilter: "",
                providerTypeFilter: "",
                providerEnabledFilter: "",
                filteredProviders: [],
                providerPage: 1,
                providersPerPage: 5,
                validatingAllKeys: false,
                validatingGroups: {}, // 跟踪每个分组的验证状态

                // 分组管理相关
                showCreateGroupModal: false,
                showEditGroupModal: false,
                showBatchAddModal: false,
                submittingGroup: false,
                editingGroupId: "",
                message: "",
                messageType: "success",

                // 密钥分页相关
                selectedKeys: [],
                keyPage: 1,
                keysPerPage: 5,
                batchKeysText: "",

                // 密钥验证相关
                validatingKeys: false,
                keyValidationStatus: {}, // 存储每个密钥的验证状态
                invalidKeyIndexes: [], // 存储无效密钥的索引
                forcingKeyStatus: {}, // 存储正在强制设置状态的密钥索引
                bulkDeletingInvalidKeys: false, // 一键删除失效密钥的状态
                clearingInvalidKeys: false, // 清除无效密钥的状态
                clearingEmptyGroups: false, // 清除空白分组的状态

                // 模型相关
                availableModels: [],
                filteredModels: [],
                loadingModels: false,
                modelSearchQuery: "",

                groupFormData: {
                    group_id: "",
                    name: "",
                    provider_type: "",
                    base_url: "",
                    enabled: true,
                    timeout: 30,
                    max_retries: 3,
                    rotation_strategy: "round_robin",
                    api_keys: [""],
                    models: [],
                    use_native_response: false,
                    rpm_limit: 0,
                    request_params: {},
                    model_mappings: {},
                    headers: {},
                    priority: 0,
                    proxy_enabled: false,
                    proxy_config: {
                        type: "http",
                        host: "",
                        port: 8080,
                        username: "",
                        password: "",
                        bypass_local: true,
                        bypass_domains: []
                    },
                    proxy_bypass_domains_text: "",
                },
                modelsText: "",

                // JSON请求参数相关
                requestParamsText: "",
                showRequestParamsHelp: false,
                requestParamsValidationMessage: "",
                requestParamsValidationError: false,
                // JSON请求头相关
                headersText: "",
                showHeadersHelp: false,
                headersValidationMessage: "",
                headersValidationError: false,

                // 模型重命名相关
                modelMappings: [],
                showModelMappingHelp: false,
                allConfiguredAliases: [], // 存储所有服务商配置的模型别名

                // 粘贴模型映射相关
                showPasteModelMappingModal: false,
                pasteModelMappingText: '',
                pasteModelMappingValidationMessage: '',
                pasteModelMappingValidationError: false,

                // 计算属性
                get providerPageOffset() {
                    return (this.providerPage - 1) * this.providersPerPage;
                },

                get paginatedProviders() {
                    const start = this.providerPageOffset;
                    const end = start + this.providersPerPage;
                    const providersArray = Object.entries(
                        this.filteredProviders,
                    );
                    return providersArray
                        .slice(start, end)
                        .reduce((acc, [groupId, provider]) => {
                            acc[groupId] = provider;
                            return acc;
                        }, {});
                },

                get totalProviderPages() {
                    return Math.ceil(
                        Object.keys(this.filteredProviders).length /
                        this.providersPerPage,
                    );
                },

                // 分组管理计算属性
                get keyPageOffset() {
                    return (this.keyPage - 1) * this.keysPerPage;
                },

                get paginatedKeys() {
                    const start = this.keyPageOffset;
                    const end = start + this.keysPerPage;
                    return this.groupFormData.api_keys.slice(start, end);
                },

                get totalKeyPages() {
                    return Math.ceil(
                        this.groupFormData.api_keys.length /
                        this.keysPerPage,
                    );
                },

                // 系统状态计算属性（已移除平均响应时间计算）

                async init() {
                    // 首先检查是否已登录
                    if (!await this.checkAuthentication()) {
                        window.location.href = '/login';
                        return;
                    }

                    // 初始化验证状态对象
                    this.validatingGroups = {};

                    // 系统健康状态和服务商分组状态需要默认展示
                    await this.loadSystemHealth();
                    await this.loadProviderStatuses();
                    await this.loadProxyKeys();
                    await this.loadAllConfiguredAliases();
                    
                    // 检查版本更新（仅在生产环境）
                    await this.checkVersion();

                    // 加载密钥状态数据，确保首次启动时能正确显示密钥数量
                    await this.loadKeyStatus();

                    // 加载已保存的验证状态（初始化时不显示消息）
                    await this.loadPersistedValidationStatus(false);
                    this.filterProviders();

                    // 启动系统健康状态的定时刷新（只刷新第一排的系统信息）
                    this.startSystemHealthRefresh();

                    // 添加页面可见性变化监听器，确保用户回到页面时数据是最新的
                    document.addEventListener("visibilitychange", () => {
                        if (!document.hidden) {
                            // 页面变为可见时，刷新数据
                            this.loadProviderStatuses();
                            this.refreshProxyKeysOnly();
                        }
                    });
                },

                // 检查用户身份验证状态
                async checkAuthentication() {
                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            console.log('No auth token found');
                            return false;
                        }

                        const response = await fetch('/auth/verify', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.valid) {
                                // 更新用户信息
                                if (data.user) {
                                    this.user = {
                                        username: data.user.username || 'admin',
                                        role: data.user.role || 'Admin'
                                    };
                                }
                                console.log('Authentication check passed');
                                return true;
                            } else {
                                console.log('Token validation failed:', data.message);
                                localStorage.removeItem('authToken');
                                return false;
                            }
                        } else {
                            console.log('Auth verification failed with status:', response.status);
                            localStorage.removeItem('authToken');
                            return false;
                        }
                    } catch (error) {
                        console.error('Authentication check error:', error);
                        localStorage.removeItem('authToken');
                        return false;
                    }
                },

                // 版本检测相关函数
                async checkVersion() {
                    if (this.checkingVersion) return;
                    
                    this.checkingVersion = true;
                    try {
                        const response = await fetch('/health/version');
                        if (response.ok) {
                            this.versionInfo = await response.json();
                        } else {
                            console.warn('版本检查失败:', response.status);
                        }
                    } catch (error) {
                        console.error('版本检查错误:', error);
                    } finally {
                        this.checkingVersion = false;
                    }
                },

                openReleaseUrl() {
                    if (this.versionInfo && this.versionInfo.releaseUrl) {
                        window.open(this.versionInfo.releaseUrl, '_blank');
                    }
                },

                // 用户设置相关函数
                closeUserSettingsModal() {
                    this.showUserSettingsModal = false;
                    this.resetUserForm();
                },

                resetUserForm() {
                    this.userForm = {
                        currentPassword: '',
                        newUsername: '',
                        newPassword: '',
                        confirmPassword: ''
                    };
                },

                async updateUserInfo() {
                    // 验证表单
                    if (!this.userForm.currentPassword) {
                        this.showMessage('请输入当前密码', 'error');
                        return;
                    }

                    if (this.userForm.newPassword && this.userForm.newPassword !== this.userForm.confirmPassword) {
                        this.showMessage('新密码与确认密码不匹配', 'error');
                        return;
                    }

                    if (this.userForm.newPassword && this.userForm.newPassword.length < 6) {
                        this.showMessage('新密码长度至少6位', 'error');
                        return;
                    }

                    // 如果没有要修改的内容
                    if (!this.userForm.newUsername && !this.userForm.newPassword) {
                        this.showMessage('请至少修改用户名或密码中的一项', 'error');
                        return;
                    }

                    this.updatingUserInfo = true;

                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        // 构建请求数据
                        const requestData = {
                            currentPassword: this.userForm.currentPassword
                        };

                        if (this.userForm.newUsername) {
                            requestData.newUsername = this.userForm.newUsername;
                        }

                        if (this.userForm.newPassword) {
                            requestData.newPassword = this.userForm.newPassword;
                        }

                        const response = await fetch('/auth/update-user', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            // 更新本地用户信息
                            if (this.userForm.newUsername) {
                                this.user.username = this.userForm.newUsername;
                            }

                            // 如果修改了密码，立即退出到登录页
                            if (this.userForm.newPassword) {
                                this.showMessage('密码已修改，即将跳转到登录页...', 'success');
                                this.closeUserSettingsModal();

                                // 1.5秒后自动跳转到登录页
                                setTimeout(() => {
                                    localStorage.removeItem('authToken');
                                    window.location.href = '/login';
                                }, 1500);
                            } else {
                                // 只修改用户名，不需要重新登录
                                this.showMessage('用户信息更新成功', 'success');
                                this.closeUserSettingsModal();
                            }
                        } else {
                            throw new Error(data.error || '更新用户信息失败');
                        }
                    } catch (error) {
                        console.error('更新用户信息失败:', error);
                        this.showMessage('更新失败: ' + error.message, 'error');
                    } finally {
                        this.updatingUserInfo = false;
                    }
                },

                async loadSystemHealth() {
                    this.loadingSystemHealth = true;
                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch("/admin/health/system", {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            this.systemHealth = await response.json();
                            // this.showMessage('系统健康状态已更新', 'success');
                        } else {
                            throw new Error("获取系统健康状态失败");
                        }
                    } catch (error) {
                        console.error(
                            "Failed to load system health:",
                            error,
                        );
                        this.showMessage(
                            "加载系统健康状态失败: " + error.message,
                            "error",
                        );
                    } finally {
                        this.loadingSystemHealth = false;
                    }
                },

                async loadProviderStatuses() {
                    this.loadingProviderStatuses = true;
                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch("/admin/groups/manage", {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log('loadProviderStatuses response:', data);
                            this.providerStatuses = data.groups || {};
                            console.log('providerStatuses after update:', this.providerStatuses);
                            this.filterProviders();
                            // this.showMessage('服务商分组状态已更新', 'success');
                        } else {
                            throw new Error("获取服务商分组状态失败");
                        }
                    } catch (error) {
                        console.error(
                            "Failed to load provider statuses:",
                            error,
                        );
                        this.showMessage(
                            "加载服务商分组状态失败: " + error.message,
                            "error",
                        );
                    } finally {
                        this.loadingProviderStatuses = false;
                    }
                },

                async refreshData() {
                    // 手动刷新时刷新所有数据
                    await this.refreshSystemData();
                },

                async refreshProviderHealth() {
                    await this.loadProviderStatuses();
                    this.lastUpdate = new Date();
                },

                // 加载所有配置的模型别名
                async loadAllConfiguredAliases() {
                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch('/admin/models/all-aliases', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.allConfiguredAliases = data.aliases || [];
                            console.log('已加载所有配置的模型别名:', this.allConfiguredAliases.length, '个');
                        } else {
                            console.error('加载所有配置别名失败:', response.status);
                        }
                    } catch (error) {
                        console.error('加载所有配置别名异常:', error);
                    }
                },

                // 清除无效密钥
                async clearInvalidKeys() {
                    try {
                        // 确认对话框
                        const confirmed = await showConfirm('此操作将删除所有状态码为401的无效密钥，包括相关的验证记录和使用统计。\n\n确定要继续吗？', '确认清除无效密钥');
                        if (!confirmed) {
                            return;
                        }

                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        // 设置加载状态
                        this.clearingInvalidKeys = true;

                        const response = await fetch('/admin/keys/clear-invalid', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // 显示操作结果
                            let message = `清除操作完成！\n`;
                            message += `• 清除密钥数量: ${result.cleared_keys_count}\n`;
                            if (result.affected_groups && result.affected_groups.length > 0) {
                                message += `• 受影响分组: ${result.affected_groups.join(', ')}\n`;
                            }
                            if (result.errors && result.errors.length > 0) {
                                message += `• 错误信息: ${result.errors.join('; ')}\n`;
                            }
                            message += `• 操作耗时: ${Math.round(result.duration_ms)}ms`;

                            await showAlert(message, 'success', '清除无效密钥完成');

                            // 刷新分组状态
                            await this.loadProviderStatuses();
                            this.lastUpdate = new Date();
                        } else {
                            throw new Error(result.message || '清除无效密钥失败');
                        }
                    } catch (error) {
                        console.error('清除无效密钥失败:', error);
                        await showAlert(`清除无效密钥失败: ${error.message}`, 'error', '操作失败');
                    } finally {
                        // 恢复按钮状态
                        this.clearingInvalidKeys = false;
                    }
                },

                // 清除空白密钥的服务商分组
                async clearEmptyGroups() {
                    try {
                        // 确认对话框
                        const confirmed = await showConfirm('此操作将标记删除所有没有密钥的服务商分组。\n\n确定要继续吗？', '确认清除空白分组');
                        if (!confirmed) {
                            return;
                        }

                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        // 设置加载状态
                        this.clearingEmptyGroups = true;

                        const response = await fetch('/admin/groups/clear-empty', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // 显示操作结果
                            let message = `清除操作完成！\n`;
                            message += `• 清除分组数量: ${result.cleared_groups_count}\n`;
                            message += `• 检查分组总数: ${result.total_groups_checked}\n`;
                            if (result.cleared_groups && result.cleared_groups.length > 0) {
                                message += `• 清除的分组: ${result.cleared_groups.map(g => g.name).join(', ')}\n`;
                            }
                            if (result.errors && result.errors.length > 0) {
                                message += `• 错误信息: ${result.errors.join('; ')}\n`;
                            }
                            message += `• 操作耗时: ${Math.round(result.duration_ms)}ms`;

                            await showAlert(message, 'success', '清除空白分组完成');

                            // 刷新分组状态
                            await this.loadProviderStatuses();
                            this.lastUpdate = new Date();
                        } else {
                            // 处理错误
                            const errorMessage = result.message || "清除空白分组失败";
                            console.error("Clear empty groups error:", result);
                            await showAlert(errorMessage, 'error', '清除空白分组失败');
                        }
                    } catch (error) {
                        console.error("Clear empty groups failed:", error);
                        await showAlert("清除空白分组失败: " + error.message, 'error', '操作失败');
                    } finally {
                        // 恢复按钮状态
                        this.clearingEmptyGroups = false;
                    }
                },

                // 导出分组配置
                async exportGroups() {
                    try {
                        let groupsToExport = [];

                        if (this.selectedGroups.length === 0) {
                            // 如果没有选中任何分组，导出所有分组
                            const confirmed = await showConfirm('没有选中任何分组，是否导出所有分组？', '确认导出');
                            if (confirmed) {
                                groupsToExport = Object.keys(this.providerStatuses);
                            } else {
                                return;
                            }
                        } else {
                            groupsToExport = this.selectedGroups;
                        }

                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch('/admin/groups/export', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                group_ids: groupsToExport
                            })
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `groups_config_${new Date().toISOString().split('T')[0]}.json`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);

                            await showAlert(`成功导出 ${groupsToExport.length} 个分组的配置`, 'success', '导出成功');
                        } else {
                            const errorData = await response.json();
                            await showAlert('导出失败: ' + (errorData.error || '未知错误'), 'error', '导出失败');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        await showAlert('导出失败: ' + error.message, 'error', '导出失败');
                    }
                },

                // 处理文件选择
                handleFileSelect(event) {
                    this.selectedFile = event.target.files[0];
                },

                // 导入分组配置
                async importGroups() {
                    if (!this.selectedFile) {
                        await showAlert('请选择配置文件', 'warning', '提示');
                        return;
                    }

                    this.importing = true;

                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const formData = new FormData();
                        formData.append('config_file', this.selectedFile);

                        const response = await fetch('/admin/groups/import', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        const data = await response.json();

                        if (data.success) {
                            let message = `成功导入 ${data.imported_count}/${data.total_groups} 个分组`;

                            if (data.errors && data.errors.length > 0) {
                                message += '\n\n错误信息:\n' + data.errors.join('\n');
                            }

                            await showAlert(message, data.errors && data.errors.length > 0 ? 'warning' : 'success', '导入结果');

                            // 重新加载服务商状态
                            await this.loadProviderStatuses();

                            // 关闭模态框并重置状态
                            this.showImportModal = false;
                            this.selectedFile = null;

                            // 重置文件输入
                            const fileInput = document.querySelector('input[type="file"]');
                            if (fileInput) {
                                fileInput.value = '';
                            }
                        } else {
                            await showAlert('导入失败: ' + (data.error || '未知错误'), 'error', '导入失败');
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        await showAlert('导入失败: ' + error.message, 'error', '导入失败');
                    } finally {
                        this.importing = false;
                    }
                },

                async checkProviderHealth(groupId) {
                    try {
                        const response = await fetch(
                            `/admin/health/providers/${groupId}`,
                        );
                        if (response.ok) {
                            const data = await response.json();
                            this.providerStatuses[groupId] = data;
                        }
                    } catch (error) {
                        console.error(
                            "Failed to check provider health:",
                            error,
                        );
                    }
                },

                async loadProviderModels() {
                    this.loadingModels = true;
                    try {
                        const url = this.selectedProvider
                            ? `/admin/models/${this.selectedProvider}`
                            : "/admin/models";

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.providerModels = data.data || {};
                        }
                    } catch (error) {
                        console.error("Failed to load models:", error);
                    } finally {
                        this.loadingModels = false;
                    }
                },

                // 移除自动刷新功能
                // toggleAutoRefresh() {
                //     this.autoRefresh = !this.autoRefresh;
                //     if (this.autoRefresh) {
                //         this.startAutoRefresh();
                //     } else {
                //         this.stopAutoRefresh();
                //     }
                // },

                // 密钥状态相关方法
                async loadKeyStatus() {
                    this.loadingKeyStatus = true;
                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch("/admin/keys/status", {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                // 计算总计数据
                                let totalKeys = 0;
                                let totalValid = 0;
                                let totalInvalid = 0;

                                for (const groupId in data.data) {
                                    const groupData = data.data[groupId];
                                    totalKeys += groupData.total_keys;
                                    totalValid += groupData.valid_keys;
                                    totalInvalid += groupData.invalid_keys;
                                }

                                this.keyStatus = {
                                    total_keys: totalKeys,
                                    total_valid: totalValid,
                                    total_invalid: totalInvalid,
                                    last_updated: new Date().toLocaleString(
                                        "zh-CN",
                                    ),
                                    groups: data.data,
                                };
                            }
                        }
                    } catch (error) {
                        console.error("Failed to load key status:", error);
                    } finally {
                        this.loadingKeyStatus = false;
                    }
                },

                async refreshKeyStatus() {
                    await this.loadKeyStatus();
                    // 移除自动加载验证状态，改为手动触发
                    // await this.loadPersistedValidationStatus();
                },

                // 加载所有分组的持久化验证状态
                async loadPersistedValidationStatus(showMessage = true) {
                    this.loadingValidation = true;
                    try {
                        // 获取所有分组ID
                        const groupIds = Object.keys(
                            this.providerStatuses || {},
                        );
                        let processedGroups = 0;

                        // 为每个分组加载验证状态
                        for (const groupId of groupIds) {
                            try {
                                const response = await fetch(
                                    `/admin/keys/validation/${groupId}`,
                                );
                                if (response.ok) {
                                    const data = await response.json();
                                    if (
                                        data.success &&
                                        data.validation_status
                                    ) {
                                        // 统计验证状态
                                        const validationStatus =
                                            data.validation_status;
                                        let validCount = 0;
                                        let invalidCount = 0;
                                        let totalCount = 0;

                                        for (const [
                                            apiKey,
                                            status,
                                        ] of Object.entries(
                                            validationStatus,
                                        )) {
                                            totalCount++;
                                            if (status.is_valid === true) {
                                                validCount++;
                                            } else if (
                                                status.is_valid === false
                                            ) {
                                                invalidCount++;
                                            }
                                        }

                                        // 更新密钥状态数据
                                        if (!this.keyStatus.groups) {
                                            this.keyStatus.groups = {};
                                        }
                                        this.keyStatus.groups[groupId] = {
                                            valid_keys: validCount,
                                            invalid_keys: invalidCount,
                                            total_keys: totalCount,
                                            last_validated:
                                                new Date().toISOString(),
                                        };
                                    }
                                }
                                processedGroups++;
                            } catch (error) {
                                console.error(
                                    `Failed to load validation status for group ${groupId}:`,
                                    error,
                                );
                                processedGroups++;
                            }
                        }

                        // 重新计算总计数据
                        if (this.keyStatus.groups) {
                            let totalKeys = 0;
                            let totalValid = 0;
                            let totalInvalid = 0;

                            for (const groupData of Object.values(
                                this.keyStatus.groups,
                            )) {
                                totalKeys += groupData.total_keys || 0;
                                totalValid += groupData.valid_keys || 0;
                                totalInvalid += groupData.invalid_keys || 0;
                            }

                            this.keyStatus.total_keys = totalKeys;
                            this.keyStatus.total_valid = totalValid;
                            this.keyStatus.total_invalid = totalInvalid;
                            this.keyStatus.last_updated =
                                new Date().toLocaleString();
                        }

                        // 显示完成消息（仅在手动调用时显示）
                        if (showMessage) {
                            this.showMessage(
                                `已检查 ${processedGroups} 个分组的密钥验证状态`,
                                "success",
                            );
                        }
                    } catch (error) {
                        console.error(
                            "Failed to load persisted validation status:",
                            error,
                        );
                        this.showMessage(
                            "加载密钥验证状态失败: " + error.message,
                            "error",
                        );
                    } finally {
                        this.loadingValidation = false;
                    }
                },

                // 服务商筛选和管理方法
                filterProviders(resetPage = true) {
                    let providers = Object.entries(this.providerStatuses);

                    // 按创建时间倒序排序（后端已经排序，但为了确保一致性）
                    providers.sort(([, a], [, b]) => {
                        const aTime = a.created_at
                            ? new Date(a.created_at)
                            : new Date(0);
                        const bTime = b.created_at
                            ? new Date(b.created_at)
                            : new Date(0);
                        return bTime - aTime; // 倒序
                    });

                    // 搜索筛选
                    if (this.providerSearchQuery.trim()) {
                        const query =
                            this.providerSearchQuery.toLowerCase();
                        providers = providers.filter(
                            ([groupId, provider]) =>
                                provider.group_name
                                    .toLowerCase()
                                    .includes(query) ||
                                provider.provider_type
                                    .toLowerCase()
                                    .includes(query) ||
                                groupId.toLowerCase().includes(query) ||
                                (provider.base_url && provider.base_url
                                    .toLowerCase()
                                    .includes(query)),
                        );
                    }

                    // 状态筛选
                    if (this.providerStatusFilter) {
                        providers = providers.filter(
                            ([groupId, provider]) => {
                                if (
                                    this.providerStatusFilter === "healthy"
                                ) {
                                    return provider.healthy;
                                } else if (
                                    this.providerStatusFilter ===
                                    "unhealthy"
                                ) {
                                    return !provider.healthy;
                                }
                                return true;
                            },
                        );
                    }

                    // 类型筛选
                    if (this.providerTypeFilter) {
                        providers = providers.filter(
                            ([groupId, provider]) =>
                                provider.provider_type ===
                                this.providerTypeFilter,
                        );
                    }

                    // 启用状态筛选
                    if (this.providerEnabledFilter) {
                        providers = providers.filter(
                            ([groupId, provider]) => {
                                if (this.providerEnabledFilter === "enabled") {
                                    return provider.enabled !== false;
                                } else if (this.providerEnabledFilter === "disabled") {
                                    return provider.enabled === false;
                                }
                                return true;
                            },
                        );
                    }

                    // 转换为对象格式，保持排序顺序
                    this.filteredProviders = {};
                    providers.forEach(([groupId, provider]) => {
                        this.filteredProviders[groupId] = provider;
                    });

                    // 重置页码（可选）
                    if (resetPage) {
                        this.providerPage = 1;
                    }
                },

                // 获取服务商卡片的CSS类
                getProviderCardClass(provider) {
                    // 首先判断是否禁用
                    if (provider.enabled === false) {
                        return 'border-gray-300 bg-gray-100';
                    }
                    
                    // 如果启用，再判断健康状态
                    if (provider.healthy) {
                        return 'border-green-200 bg-green-50';
                    } else {
                        return 'border-red-200 bg-red-50';
                    }
                },

                async validateAllKeys() {
                    this.validatingAllKeys = true;
                    try {
                        await this.loadKeyStatus();
                        // 检查是否有失效密钥
                        const hasInvalidKeys =
                            this.keyStatus.total_invalid > 0;
                        if (hasInvalidKeys) {
                            // 如果有失效密钥，可以选择打开分组管理页面
                            if (
                                confirm(
                                    `发现 ${this.keyStatus.total_invalid} 个失效密钥，是否打开分组管理页面进行处理？`,
                                )
                            ) {
                                window.open("/groups", "_blank");
                            }
                        } else {
                            alert("所有密钥都是有效的！");
                        }
                    } catch (error) {
                        console.error("Failed to validate keys:", error);
                        alert("验证密钥时出错，请稍后重试");
                    } finally {
                        this.validatingAllKeys = false;
                    }
                },

                // 验证单个分组的密钥
                async validateGroupKeys(groupId, provider) {
                    // 确保 validatingGroups 对象存在并设置验证状态
                    if (!this.validatingGroups) {
                        this.validatingGroups = {};
                    }
                    this.validatingGroups[groupId] = true;

                    // 强制更新UI
                    this.$nextTick(() => {
                        this.validatingGroups = {
                            ...this.validatingGroups,
                        };
                    });

                    try {
                        // 获取分组的完整数据
                        const response = await fetch(
                            "/admin/groups/manage",
                        );
                        if (!response.ok) {
                            throw new Error("Failed to fetch group data");
                        }

                        const data = await response.json();
                        const groupData = data.groups[groupId];

                        if (
                            !groupData ||
                            !groupData.api_keys ||
                            groupData.api_keys.length === 0
                        ) {
                            alert("该分组没有配置API密钥");
                            return;
                        }

                        // 过滤掉空密钥
                        const validKeys = groupData.api_keys.filter(
                            (key) => key && key.trim().length > 0,
                        );

                        if (validKeys.length === 0) {
                            alert("该分组没有有效的API密钥");
                            return;
                        }

                        // 发送验证请求
                        const validateResponse = await fetch(
                            `/admin/keys/validate/${groupId}`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    api_keys: validKeys,
                                }),
                            },
                        );

                        if (!validateResponse.ok) {
                            throw new Error("验证请求失败");
                        }

                        const result = await validateResponse.json();

                        if (result.success) {
                            const validCount = result.valid_keys || 0;
                            const invalidCount = result.invalid_keys || 0;
                            const totalCount = result.total_keys || 0;

                            // 更新本地密钥状态数据
                            if (!this.keyStatus.groups) {
                                this.keyStatus.groups = {};
                            }
                            this.keyStatus.groups[groupId] = {
                                valid_keys: validCount,
                                invalid_keys: invalidCount,
                                total_keys: totalCount,
                                last_validated: new Date().toISOString(),
                            };

                            // 显示结果
                            const message =
                                `分组 "${provider.group_name}" 密钥验证完成：\n\n` +
                                `✅ 有效密钥：${validCount}\n` +
                                `❌ 无效密钥：${invalidCount}\n` +
                                `📊 总计：${totalCount}\n\n` +
                                `验证结果已保存到密钥管理列表中`;

                            alert(message);

                            // 刷新服务商状态和密钥状态
                            await this.loadProviderStatuses();
                            await this.refreshKeyStatus();
                        } else {
                            throw new Error(result.message || "验证失败");
                        }
                    } catch (error) {
                        console.error("验证分组密钥失败:", error);
                        alert(`验证分组密钥失败：${error.message}`);
                    } finally {
                        // 清除验证状态
                        if (this.validatingGroups) {
                            this.validatingGroups[groupId] = false;
                            // 强制更新UI
                            this.$nextTick(() => {
                                this.validatingGroups = {
                                    ...this.validatingGroups,
                                };
                            });
                        }
                    }
                },

                showProviderDetails(groupId, provider) {
                    const keyStatusData = this.keyStatus.groups[groupId];
                    let detailsHtml = `
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold">${provider.group_name} (${groupId})</h3>
                                <p class="text-sm text-gray-600">${provider.provider_type.toUpperCase()}</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">状态:</span>
                                    <span class="${provider.healthy ? "text-green-600" : "text-red-600"}">${provider.healthy ? "健康" : "异常"}</span>
                                </div>
                                <div>
                                    <span class="font-medium">响应时间:</span>
                                    <span>${this.formatResponseTime(provider.response_time)}</span>
                                </div>
                                <div>
                                    <span class="font-medium">总密钥数:</span>
                                    <span>${provider.total_keys}</span>
                                </div>
                                <div>
                                    <span class="font-medium">活跃密钥:</span>
                                    <span>${provider.active_keys}</span>
                                </div>
                            </div>
                    `;

                    if (keyStatusData) {
                        detailsHtml += `
                            <div class="border-t pt-4">
                                <h4 class="font-medium mb-2">密钥验证状态:</h4>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-green-600">${keyStatusData.valid_keys}</div>
                                        <div class="text-gray-600">有效</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-red-600">${keyStatusData.invalid_keys}</div>
                                        <div class="text-gray-600">无效</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-gray-600">${keyStatusData.total_keys}</div>
                                        <div class="text-gray-600">总计</div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">测试模型: ${keyStatusData.test_model}</p>
                            </div>
                        `;
                    }

                    if (provider.last_error) {
                        detailsHtml += `
                            <div class="border-t pt-4">
                                <h4 class="font-medium mb-2 text-red-600">错误信息:</h4>
                                <p class="text-sm text-red-700 bg-red-50 p-2 rounded">${provider.last_error}</p>
                            </div>
                        `;
                    }

                    detailsHtml += "</div>";

                    // 这里可以使用一个模态框来显示详情，暂时使用alert
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = detailsHtml;
                    alert(
                        `${provider.group_name} 详细信息\n\n状态: ${provider.healthy ? "健康" : "异常"}\n响应时间: ${this.formatResponseTime(provider.response_time)}\n密钥: ${provider.active_keys}/${provider.total_keys}`,
                    );
                },

                // 分组管理方法
                openCreateGroupModal() {
                    this.resetGroupForm();
                    this.showCreateGroupModal = true;
                },

                // 强制刷新表单UI显示
                forceRefreshFormUI() {
                    setTimeout(() => {
                        // 获取所有需要更新的表单元素
                        const formElements = [
                            {
                                selector:
                                    'input[x-model="groupFormData.rpm_limit"]',
                                value: this.groupFormData.rpm_limit,
                                event: "input",
                            },
                            {
                                selector:
                                    'input[x-model="groupFormData.use_native_response"]',
                                value: this.groupFormData
                                    .use_native_response,
                                event: "change",
                                isCheckbox: true,
                            },
                            {
                                selector:
                                    'input[x-model="groupFormData.timeout"]',
                                value: this.groupFormData.timeout,
                                event: "input",
                            },
                            {
                                selector:
                                    'input[x-model="groupFormData.max_retries"]',
                                value: this.groupFormData.max_retries,
                                event: "input",
                            },
                        ];

                        formElements.forEach((element) => {
                            const el = document.querySelector(
                                element.selector,
                            );
                            if (el) {
                                if (element.isCheckbox) {
                                    el.checked = Boolean(element.value);
                                } else {
                                    el.value = element.value;
                                }
                                el.dispatchEvent(
                                    new Event(element.event, {
                                        bubbles: true,
                                    }),
                                );
                            }
                        });
                    }, 100);
                },

                async editGroup(groupId, provider) {
                    this.editingGroupId = groupId;

                    try {
                        // 从分组管理接口获取完整的分组数据
                        const response = await fetch(
                            "/admin/groups/manage",
                        );
                        if (!response.ok) {
                            throw new Error("Failed to fetch group data");
                        }

                        const data = await response.json();
                        const fullGroupData = data.groups[groupId];

                        if (!fullGroupData) {
                            throw new Error("Group data not found");
                        }

                        // 确保API密钥数组至少有一个空元素
                        let apiKeys = [""];
                        if (
                            fullGroupData.api_keys &&
                            Array.isArray(fullGroupData.api_keys) &&
                            fullGroupData.api_keys.length > 0
                        ) {
                            apiKeys = [...fullGroupData.api_keys];
                        }

                        this.groupFormData = {
                            group_id: groupId,
                            name: fullGroupData.group_name || "",
                            provider_type:
                                fullGroupData.provider_type || "",
                            base_url: fullGroupData.base_url || "",
                            enabled: fullGroupData.enabled !== false,
                            timeout: parseInt(fullGroupData.timeout) || 30,
                            max_retries:
                                parseInt(fullGroupData.max_retries) || 3,
                            rotation_strategy:
                                fullGroupData.rotation_strategy ||
                                "round_robin",
                            api_keys: apiKeys,
                            models: fullGroupData.models || [], // 使用从后端获取的模型数据
                            use_native_response: Boolean(
                                fullGroupData.use_native_response,
                            ),
                            rpm_limit:
                                parseInt(fullGroupData.rpm_limit) || 0,
                            test_model: fullGroupData.test_model || "",
                            proxy_enabled: Boolean(fullGroupData.proxy_enabled),
                            proxy_config: fullGroupData.proxy_config ? {
                                type: fullGroupData.proxy_config.type || "http",
                                host: fullGroupData.proxy_config.host || "",
                                port: parseInt(fullGroupData.proxy_config.port) || 8080,
                                username: fullGroupData.proxy_config.username || "",
                                password: fullGroupData.proxy_config.password || "",
                                bypass_local: fullGroupData.proxy_config.bypass_local !== undefined ? fullGroupData.proxy_config.bypass_local : true,
                                bypass_domains: fullGroupData.proxy_config.bypass_domains || []
                            } : {
                                type: "http",
                                host: "",
                                port: 8080,
                                username: "",
                                password: "",
                                bypass_local: true,
                                bypass_domains: []
                            },
                            proxy_bypass_domains_text: fullGroupData.proxy_config && fullGroupData.proxy_config.bypass_domains ? 
                                fullGroupData.proxy_config.bypass_domains.join('\n') : "",
                        };

                        this.modelsText = (fullGroupData.models || []).join(
                            "\n",
                        );
                        
                        // 确保modelsText和groupFormData.models同步
                        if (this.modelsText.trim()) {
                            this.syncTextToModels();
                        }

                        // 加载JSON请求参数
                        if (
                            fullGroupData.parameter_overrides &&
                            Object.keys(fullGroupData.parameter_overrides)
                                .length > 0
                        ) {
                            this.requestParamsText = JSON.stringify(
                                fullGroupData.parameter_overrides,
                                null,
                                2,
                            );
                        } else {
                            this.requestParamsText = "";
                        }
                        // 加载JSON请求头
                        if (
                            fullGroupData.headers &&
                            Object.keys(fullGroupData.headers)
                                .length > 0
                        ) {
                            this.headersText = JSON.stringify(
                                fullGroupData.headers,
                                null,
                                2,
                            );
                        } else {
                            this.headersText = "";
                        }

                        // 加载模型映射
                        this.modelMappings = [];
                        if (
                            fullGroupData.model_aliases &&
                            Object.keys(fullGroupData.model_aliases)
                                .length > 0
                        ) {
                            for (const [alias, original] of Object.entries(
                                fullGroupData.model_aliases,
                            )) {
                                this.modelMappings.push({
                                    alias: alias,
                                    original: original,
                                });
                            }
                        }

                        // 使用setTimeout确保所有数据都已经设置完成
                        setTimeout(() => {
                            // 强制触发响应式更新
                            this.modelMappings = [...this.modelMappings];
                        }, 100);

                        this.selectedKeys = [];
                        this.keyPage = 1;
                        this.availableModels = [];
                        this.filteredModels = [];
                        this.modelSearchQuery = "";
                        this.keyValidationStatus = {};
                        this.invalidKeyIndexes = [];
                        this.requestParamsValidationMessage = "";
                        this.requestParamsValidationError = false;

                        this.showEditGroupModal = true;

                        // 延迟刷新表单UI，确保模态框完全显示后再刷新
                        setTimeout(() => {
                            this.forceRefreshFormUI();
                        }, 200);

                        // 自动加载验证状态以确保一键删除功能正常工作
                        await this.loadKeyValidationStatus(groupId);
                    } catch (error) {
                        console.error("获取分组数据失败:", error);
                        alert("获取分组数据失败，请稍后重试");
                    }
                },

                async toggleGroup(groupId, provider) {
                    try {
                        const response = await fetch(
                            `/admin/groups/${groupId}/toggle`,
                            {
                                method: "POST",
                            },
                        );

                        const data = await response.json();

                        if (response.ok) {
                            this.showMessage(data.message, "success");
                            // 重新加载服务商状态以反映分组状态变化
                            await this.loadProviderStatuses();
                        } else {
                            this.showMessage(
                                data.message || "操作失败",
                                "error",
                            );
                        }
                    } catch (error) {
                        this.showMessage(
                            "网络错误: " + error.message,
                            "error",
                        );
                    }
                },

                async deleteGroup(groupId, provider) {
                    if (
                        !confirm(
                            `确定要删除分组 "${provider.group_name}" 吗？此操作不可恢复。`,
                        )
                    ) {
                        return;
                    }

                    try {
                        const response = await fetch(
                            `/admin/groups/${groupId}`,
                            {
                                method: "DELETE",
                            },
                        );

                        if (response.ok) {
                            this.showMessage("分组删除成功", "success");
                            // 重新加载服务商状态以移除已删除的分组
                            await this.loadProviderStatuses();
                        } else {
                            // 只有非204响应才尝试解析JSON
                            let errorMessage = "删除失败";
                            if (response.status !== 204) {
                                try {
                                    const data = await response.json();
                                    errorMessage = data.message || errorMessage;
                                } catch (e) {
                                    // 如果解析JSON失败，使用默认错误消息
                                }
                            }
                            this.showMessage(errorMessage, "error");
                        }
                    } catch (error) {
                        this.showMessage(
                            "网络错误: " + error.message,
                            "error",
                        );
                    }
                },

                async submitGroupForm() {
                    this.submittingGroup = true;
                    try {
                        // 保存当前的页面状态（用于编辑模式保持位置）
                        const currentPage = this.providerPage;
                        const currentSearchQuery = this.providerSearchQuery;
                        const currentStatusFilter =
                            this.providerStatusFilter;
                        const currentTypeFilter = this.providerTypeFilter;
                        const currentEnabledFilter = this.providerEnabledFilter;

                        // 处理模型列表 - 只使用文本框输入的模型（统一管理）
                        const manualModels = this.modelsText
                            .split("\n")
                            .map((line) => line.trim())
                            .filter((line) => line.length > 0);

                        // 去重处理模型列表
                        const allModels = [...new Set(manualModels)];
                        this.groupFormData.models = allModels;

                        // 过滤空的API密钥并去重
                        const validKeys = this.groupFormData.api_keys
                            .map(key => key.trim())
                            .filter(key => key.length > 0);

                        // 去重处理
                        const uniqueKeys = [...new Set(validKeys)];
                        this.groupFormData.api_keys = uniqueKeys;

                        // 如果发现重复密钥，显示提示
                        if (validKeys.length !== uniqueKeys.length) {
                            const duplicateCount = validKeys.length - uniqueKeys.length;
                            this.showMessage(
                                `检测到 ${duplicateCount} 个重复密钥已自动去除`,
                                "success"
                            );
                        }

                        // 处理JSON请求参数
                        if (this.requestParamsText.trim()) {
                            try {
                                this.groupFormData.request_params =
                                    JSON.parse(
                                        this.requestParamsText.trim(),
                                    );
                                this.requestParamsValidationMessage = "";
                                this.requestParamsValidationError = false;
                            } catch (e) {
                                this.requestParamsValidationMessage =
                                    "JSON格式错误: " + e.message;
                                this.requestParamsValidationError = true;
                                this.submittingGroup = false;
                                return;
                            }
                        } else {
                            this.groupFormData.request_params = {};
                        }

                        // 处理JSON请求头
                        if (this.headersText.trim()) {
                            try {
                                this.groupFormData.headers =
                                    JSON.parse(
                                        this.headersText.trim(),
                                    );
                                this.headersValidationMessage = "";
                                this.headersValidationError = false;
                            } catch (e) {
                                this.headersValidationMessage =
                                    "JSON格式错误: " + e.message;
                                this.headersValidationError = true;
                                this.submittingGroup = false;
                                return;
                            }
                        } else {
                            this.groupFormData.headers = {};
                        }

                        // 处理模型映射
                        const modelMappings = {};
                        for (const mapping of this.modelMappings) {
                            if (
                                mapping.alias &&
                                mapping.alias.trim() &&
                                mapping.original &&
                                mapping.original.trim()
                            ) {
                                const alias = mapping.alias.trim();
                                const original = mapping.original.trim();

                                // 检查是否已存在相同的别名
                                if (modelMappings[alias] && modelMappings[alias] !== original) {
                                    // 如果别名已存在且映射到不同的原始模型，给出警告
                                    const message = `警告：别名 "${alias}" 已映射到模型 "${modelMappings[alias]}"，现在将被覆盖为 "${original}"。\n\n如果您想要多个模型都使用相同的别名，建议：\n1. 在不同的分组中分别设置映射\n2. 或者使用不同的别名（如 gpt-4-v1, gpt-4-v2）`;

                                    if (!confirm(message + '\n\n是否继续保存？')) {
                                        return; // 用户取消保存
                                    }
                                }

                                modelMappings[alias] = original;
                            }
                        }
                        this.groupFormData.model_mappings = modelMappings;

                        // 确保数字字段是正确的类型
                        this.groupFormData.timeout =
                            parseInt(this.groupFormData.timeout) || 30;
                        this.groupFormData.max_retries =
                            parseInt(this.groupFormData.max_retries) || 3;
                        this.groupFormData.rpm_limit =
                            parseInt(this.groupFormData.rpm_limit) || 0;

                        const url = this.showCreateGroupModal
                            ? "/admin/groups"
                            : `/admin/groups/${this.editingGroupId}`;
                        const method = this.showCreateGroupModal
                            ? "POST"
                            : "PUT";

                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        // 将前端字段名映射到后端期望的字段名
                        const requestData = {
                            id: this.groupFormData.group_id || "",
                            group_name: this.groupFormData.name,
                            provider_type: this.groupFormData.provider_type,
                            base_url: this.groupFormData.base_url || "",
                            api_keys: this.groupFormData.api_keys || [],
                            models: this.groupFormData.models || [],
                            model_aliases: this.groupFormData.model_mappings || {},
                            parameter_overrides: this.groupFormData.request_params || {},
                            headers: this.groupFormData.headers || {},
                            balance_policy: this.groupFormData.rotation_strategy || "round_robin",
                            retry_count: this.groupFormData.max_retries || 3,
                            timeout: this.groupFormData.timeout || 60,
                            rpm_limit: this.groupFormData.rpm_limit || 0,
                            test_model: this.groupFormData.test_model || null,
                            priority: this.groupFormData.priority || 0,
                            enabled: this.groupFormData.enabled !== undefined ? this.groupFormData.enabled : true,
                            proxy_enabled: this.groupFormData.proxy_enabled || false,
                            proxy_config: this.groupFormData.proxy_enabled ? {
                                type: this.groupFormData.proxy_config.type || "http",
                                host: this.groupFormData.proxy_config.host || "",
                                port: parseInt(this.groupFormData.proxy_config.port) || 8080,
                                username: this.groupFormData.proxy_config.username || "",
                                password: this.groupFormData.proxy_config.password || "",
                                bypass_local: this.groupFormData.proxy_config.bypass_local !== undefined ? this.groupFormData.proxy_config.bypass_local : true,
                                bypass_domains: this.groupFormData.proxy_bypass_domains_text ? 
                                    this.groupFormData.proxy_bypass_domains_text.split('\n').map(d => d.trim()).filter(d => d) : []
                            } : null
                        };

                        // 验证必需字段
                        if (this.showCreateGroupModal && (!requestData.id || !requestData.id.trim())) {
                            throw new Error("分组ID不能为空");
                        }
                        if (!requestData.group_name || !requestData.group_name.trim()) {
                            throw new Error("分组名称不能为空");
                        }
                        if (!requestData.provider_type || !requestData.provider_type.trim()) {
                            throw new Error("服务商类型不能为空");
                        }
                        if (!requestData.api_keys || requestData.api_keys.length === 0 ||
                            requestData.api_keys.every(key => !key || !key.trim())) {
                            throw new Error("至少需要提供一个API密钥");
                        }

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                "Content-Type": "application/json",
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(requestData),
                        });

                        const data = await response.json();

                        if (response.ok) {
                            console.log('submitGroupForm response:', data);
                            this.showMessage(data.message, "success");

                            // 如果是编辑模式，更新本地数据而不重新加载整个列表
                            if (
                                !this.showCreateGroupModal &&
                                this.editingGroupId
                            ) {
                                // 更新本地providerStatuses中的数据
                                if (
                                    this.providerStatuses[
                                    this.editingGroupId
                                    ]
                                ) {
                                    // 更新用户可编辑的字段，保留健康检查相关字段
                                    Object.assign(
                                        this.providerStatuses[
                                        this.editingGroupId
                                        ],
                                        {
                                            group_name:
                                                this.groupFormData.name, // 注意：groupFormData中使用的是name字段
                                            provider_type:
                                                this.groupFormData
                                                    .provider_type,
                                            base_url:
                                                this.groupFormData.base_url,
                                            models: this.groupFormData
                                                .models,
                                            model_mappings:
                                                this.groupFormData
                                                    .model_mappings,
                                            use_native_response:
                                                this.groupFormData
                                                    .use_native_response,
                                            rpm_limit:
                                                this.groupFormData
                                                    .rpm_limit,
                                            timeout:
                                                this.groupFormData.timeout,
                                            max_retries:
                                                this.groupFormData
                                                    .max_retries,
                                            request_params:
                                                this.groupFormData
                                                    .request_params,
                                            enabled:
                                                this.groupFormData.enabled,
                                            rotation_strategy:
                                                this.groupFormData
                                                    .rotation_strategy,
                                            // 注意：不更新 healthy, last_check, response_time, last_error, total_keys, active_keys 等健康检查字段
                                        },
                                    );
                                }

                                this.closeGroupModal();

                                // 恢复页面状态
                                this.providerPage = currentPage;
                                this.providerSearchQuery =
                                    currentSearchQuery;
                                this.providerStatusFilter =
                                    currentStatusFilter;
                                this.providerTypeFilter = currentTypeFilter;
                                this.providerEnabledFilter = currentEnabledFilter;

                                // 重新过滤服务商以反映更新，但不重置页面位置
                                this.filterProviders(false);
                            } else {
                                // 创建模式：重新加载服务商状态以显示新添加的分组
                                console.log('Creating new group, reloading provider statuses...');
                                this.closeGroupModal();
                                await this.loadProviderStatuses();
                                console.log('Provider statuses reloaded:', this.providerStatuses);
                            }

                            // 额外的数据验证，确保保存的数据正确
                            setTimeout(async () => {
                                if (
                                    this.editingGroupId &&
                                    this.providerStatuses[
                                    this.editingGroupId
                                    ]
                                ) {
                                    const savedData =
                                        this.providerStatuses[
                                        this.editingGroupId
                                        ];
                                }
                            }, 500);
                        } else {
                            this.showMessage(
                                data.message || "操作失败",
                                "error",
                            );
                        }
                    } catch (error) {
                        this.showMessage(
                            "网络错误: " + error.message,
                            "error",
                        );
                    } finally {
                        this.submittingGroup = false;
                    }
                },

                closeGroupModal() {
                    this.showCreateGroupModal = false;
                    this.showEditGroupModal = false;
                    this.showBatchAddModal = false;
                    this.editingGroupId = "";
                    this.resetGroupForm();
                },

                resetGroupForm() {
                    this.groupFormData = {
                        group_id: "",
                        name: "",
                        provider_type: "",
                        base_url: "",
                        enabled: true,
                        timeout: 30,
                        max_retries: 3,
                        rotation_strategy: "round_robin",
                        api_keys: [""],
                        models: [],
                        use_native_response: false,
                        rpm_limit: 0,
                        request_params: {},
                        model_mappings: {},
                        headers: {},
                        priority: 0,
                        proxy_enabled: false,
                        proxy_config: {
                            type: "http",
                            host: "",
                            port: 8080,
                            username: "",
                            password: "",
                            bypass_local: true,
                            bypass_domains: []
                        },
                        proxy_bypass_domains_text: "",
                    };
                    this.modelsText = "";
                    this.selectedKeys = [];
                    this.keyPage = 1;
                    this.availableModels = [];
                    this.filteredModels = [];
                    this.modelSearchQuery = "";
                    this.batchKeysText = "";
                    this.keyValidationStatus = {};
                    this.invalidKeyIndexes = [];
                    this.forcingKeyStatus = {};
                    this.bulkDeletingInvalidKeys = false;

                    // 重置JSON参数相关字段
                    this.requestParamsText = "";
                    this.showRequestParamsHelp = false;
                    this.requestParamsValidationMessage = "";
                    this.requestParamsValidationError = false;
                    // 重置JSON请求头相关字段
                    this.headersText = "";
                    this.showHeadersHelp = false;
                    this.headersValidationMessage = "";
                    this.headersValidationError = false;

                    // 重置模型映射相关字段
                    this.modelMappings = [];
                    this.showModelMappingHelp = false;
                },

                // 服务商类型变化时自动填充Base URL
                onProviderTypeChange() {
                    const defaultBaseUrls = {
                        openai: "https://api.openai.com/v1",
                        anthropic: "https://api.anthropic.com",
                        gemini: "https://generativelanguage.googleapis.com",
                        azure_openai:
                            "https://your-resource-name.openai.azure.com",
                        openrouter: "https://openrouter.ai/api/v1",
                    };

                    const providerType = this.groupFormData.provider_type;
                    if (providerType && defaultBaseUrls[providerType]) {
                        // 只有当Base URL为空或者是默认值时才自动填充
                        const currentBaseUrl = this.groupFormData.base_url;
                        const isDefaultUrl =
                            Object.values(defaultBaseUrls).includes(
                                currentBaseUrl,
                            );

                        if (!currentBaseUrl || isDefaultUrl) {
                            this.groupFormData.base_url =
                                defaultBaseUrls[providerType];
                        }
                    }
                },

                addGroupApiKey() {
                    this.groupFormData.api_keys.push("");
                },

                // 检查密钥是否重复的辅助函数
                checkDuplicateKeys(keys) {
                    const keyMap = new Map();
                    const duplicates = [];
                    const unique = [];

                    keys.forEach((key, index) => {
                        const trimmedKey = key.trim();
                        if (trimmedKey.length === 0) return;

                        if (keyMap.has(trimmedKey)) {
                            duplicates.push({
                                key: trimmedKey,
                                indexes: [keyMap.get(trimmedKey), index]
                            });
                        } else {
                            keyMap.set(trimmedKey, index);
                            unique.push(trimmedKey);
                        }
                    });

                    return {
                        duplicates,
                        unique,
                        hasDuplicates: duplicates.length > 0
                    };
                },

                // 去重密钥数组
                deduplicateKeys(keys) {
                    const seen = new Set();
                    return keys.filter(key => {
                        const trimmedKey = key.trim();
                        if (trimmedKey.length === 0) return false;
                        if (seen.has(trimmedKey)) return false;
                        seen.add(trimmedKey);
                        return true;
                    });
                },

                // 检查当前密钥列表中的重复项
                checkCurrentKeyDuplicates() {
                    const duplicateIndexes = new Set();
                    const seen = new Map();

                    this.groupFormData.api_keys.forEach((key, index) => {
                        const trimmedKey = key.trim();
                        if (trimmedKey.length === 0) return;

                        if (seen.has(trimmedKey)) {
                            // 标记当前索引和之前的索引为重复
                            duplicateIndexes.add(index);
                            duplicateIndexes.add(seen.get(trimmedKey));
                        } else {
                            seen.set(trimmedKey, index);
                        }
                    });

                    return duplicateIndexes;
                },

                // 移除所有重复的密钥，只保留第一个
                removeDuplicateKeys() {
                    const originalLength = this.groupFormData.api_keys.length;
                    const validKeys = this.groupFormData.api_keys.filter(key => key.trim().length > 0);
                    const uniqueKeys = this.deduplicateKeys(validKeys);

                    // 如果所有密钥都被去重了，至少保留一个空项
                    if (uniqueKeys.length === 0) {
                        this.groupFormData.api_keys = [""];
                    } else {
                        this.groupFormData.api_keys = uniqueKeys;
                    }

                    const removedCount = originalLength - this.groupFormData.api_keys.length;
                    if (removedCount > 0) {
                        this.showMessage(`已移除 ${removedCount} 个重复密钥`, "success");
                    }

                    // 重置页码和选中状态
                    this.selectedKeys = [];
                    this.keyPage = 1;
                },

                removeGroupApiKey(index) {
                    if (this.groupFormData.api_keys.length > 1) {
                        this.groupFormData.api_keys.splice(index, 1);
                        // 调整页码如果当前页没有数据了
                        if (
                            this.keyPageOffset >=
                            this.groupFormData.api_keys.length &&
                            this.keyPage > 1
                        ) {
                            this.keyPage--;
                        }
                        // 清除选中状态
                        this.selectedKeys = this.selectedKeys.filter(
                            (i) => i < this.groupFormData.api_keys.length,
                        );
                    }
                },

                // 批量添加密钥
                addBatchKeys() {
                    const keys = this.batchKeysText
                        .split("\n")
                        .map((line) => line.trim())
                        .filter((line) => line.length > 0);

                    if (keys.length > 0) {
                        // 获取现有的非空密钥
                        const existingKeys = this.groupFormData.api_keys
                            .map(key => key.trim())
                            .filter(key => key.length > 0);

                        // 检查重复密钥
                        const duplicateKeys = [];
                        const newUniqueKeys = [];

                        keys.forEach(key => {
                            if (existingKeys.includes(key)) {
                                duplicateKeys.push(key);
                            } else if (!newUniqueKeys.includes(key)) {
                                newUniqueKeys.push(key);
                            }
                        });

                        // 添加新的唯一密钥
                        if (newUniqueKeys.length > 0) {
                            this.groupFormData.api_keys.push(...newUniqueKeys);
                        }

                        this.batchKeysText = "";
                        this.showBatchAddModal = false;

                        // 显示结果消息
                        let message = `成功添加 ${newUniqueKeys.length} 个密钥`;
                        if (duplicateKeys.length > 0) {
                            message += `，跳过 ${duplicateKeys.length} 个重复密钥`;
                        }
                        this.showMessage(message, "success");
                    }
                },

                // 删除选中的密钥
                deleteSelectedKeys() {
                    if (this.selectedKeys.length === 0) return;

                    if (
                        !confirm(
                            `确定要删除选中的 ${this.selectedKeys.length} 个密钥吗？`,
                        )
                    ) {
                        return;
                    }

                    // 按索引倒序删除，避免索引变化问题
                    const sortedIndexes = [...this.selectedKeys].sort(
                        (a, b) => b - a,
                    );
                    sortedIndexes.forEach((index) => {
                        this.groupFormData.api_keys.splice(index, 1);
                    });

                    // 确保至少有一个空项
                    if (this.groupFormData.api_keys.length === 0) {
                        this.groupFormData.api_keys.push("");
                    }

                    // 清除选中状态
                    this.selectedKeys = [];

                    // 调整页码
                    if (
                        this.keyPageOffset >=
                        this.groupFormData.api_keys.length &&
                        this.keyPage > 1
                    ) {
                        this.keyPage--;
                    }

                    this.showMessage(
                        `成功删除 ${sortedIndexes.length} 个密钥`,
                        "success",
                    );
                },

                // 删除失效密钥
                deleteInvalidKeys() {
                    // 找出所有失效的密钥索引
                    const invalidIndexes = [];
                    this.groupFormData.api_keys.forEach((key, index) => {
                        if (
                            key.trim() &&
                            this.keyValidationStatus[index] === "invalid"
                        ) {
                            invalidIndexes.push(index);
                        }
                    });

                    if (invalidIndexes.length === 0) {
                        this.showMessage("没有找到失效的密钥", "info");
                        return;
                    }

                    if (
                        !confirm(
                            `确定要删除 ${invalidIndexes.length} 个失效密钥吗？`,
                        )
                    ) {
                        return;
                    }

                    // 按索引倒序删除
                    const sortedIndexes = [...invalidIndexes].sort(
                        (a, b) => b - a,
                    );
                    sortedIndexes.forEach((index) => {
                        this.groupFormData.api_keys.splice(index, 1);
                    });

                    // 确保至少有一个空项
                    if (this.groupFormData.api_keys.length === 0) {
                        this.groupFormData.api_keys.push("");
                    }

                    // 重新构建验证状态，移除已删除密钥的状态
                    const newValidationStatus = {};
                    const newInvalidIndexes = [];
                    this.groupFormData.api_keys.forEach((key, newIndex) => {
                        // 找到原来的索引对应的状态
                        for (
                            let oldIndex = 0;
                            oldIndex <
                            this.groupFormData.api_keys.length +
                            sortedIndexes.length;
                            oldIndex++
                        ) {
                            if (
                                !sortedIndexes.includes(oldIndex) &&
                                this.keyValidationStatus[oldIndex]
                            ) {
                                const adjustedIndex =
                                    oldIndex -
                                    sortedIndexes.filter(
                                        (idx) => idx < oldIndex,
                                    ).length;
                                if (adjustedIndex === newIndex) {
                                    newValidationStatus[newIndex] =
                                        this.keyValidationStatus[oldIndex];
                                    if (
                                        this.keyValidationStatus[
                                        oldIndex
                                        ] === "invalid"
                                    ) {
                                        newInvalidIndexes.push(newIndex);
                                    }
                                    break;
                                }
                            }
                        }
                    });

                    this.keyValidationStatus = newValidationStatus;
                    this.invalidKeyIndexes = newInvalidIndexes;

                    // 调整页码
                    if (
                        this.keyPageOffset >=
                        this.groupFormData.api_keys.length &&
                        this.keyPage > 1
                    ) {
                        this.keyPage--;
                    }

                    this.showMessage(
                        `成功删除 ${sortedIndexes.length} 个失效密钥`,
                        "success",
                    );
                },

                // 验证密钥
                async validateKeys() {
                    const validKeys = this.groupFormData.api_keys.filter(
                        (key) => key.trim().length > 0,
                    );
                    if (validKeys.length === 0) {
                        this.showMessage(
                            "请先添加至少一个API密钥",
                            "error",
                        );
                        return;
                    }

                    if (
                        !this.groupFormData.provider_type ||
                        !this.groupFormData.base_url
                    ) {
                        this.showMessage(
                            "请先填写服务商类型和Base URL",
                            "error",
                        );
                        return;
                    }

                    this.validatingKeys = true;
                    this.keyValidationStatus = {};
                    this.invalidKeyIndexes = [];

                    try {
                        // 标记所有密钥为验证中
                        this.groupFormData.api_keys.forEach(
                            (key, index) => {
                                if (key.trim().length > 0) {
                                    this.keyValidationStatus[index] =
                                        "validating";
                                }
                            },
                        );

                        // 创建临时分组配置来验证密钥
                        const tempGroupData = {
                            name: this.groupFormData.name || "temp",
                            provider_type: this.groupFormData.provider_type,
                            base_url: this.groupFormData.base_url,
                            enabled: true,
                            timeout: this.groupFormData.timeout || 30,
                            max_retries:
                                this.groupFormData.max_retries || 3,
                            rotation_strategy:
                                this.groupFormData.rotation_strategy ||
                                "round_robin",
                            api_keys: validKeys,
                        };

                        const response = await fetch(
                            "/admin/keys/validate",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(tempGroupData),
                            },
                        );

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.results) {
                                let validCount = 0;
                                let invalidCount = 0;

                                // 更新验证状态
                                data.results.forEach(
                                    (result, resultIndex) => {
                                        // 找到对应的原始索引
                                        let originalIndex = 0;
                                        let validKeyIndex = 0;
                                        for (
                                            let i = 0;
                                            i <
                                            this.groupFormData.api_keys
                                                .length;
                                            i++
                                        ) {
                                            if (
                                                this.groupFormData.api_keys[
                                                    i
                                                ].trim().length > 0
                                            ) {
                                                if (
                                                    validKeyIndex ===
                                                    resultIndex
                                                ) {
                                                    originalIndex = i;
                                                    break;
                                                }
                                                validKeyIndex++;
                                            }
                                        }

                                        if (result.valid) {
                                            this.keyValidationStatus[
                                                originalIndex
                                            ] = "valid";
                                            validCount++;
                                        } else {
                                            this.keyValidationStatus[
                                                originalIndex
                                            ] = "invalid";
                                            this.invalidKeyIndexes.push(
                                                originalIndex,
                                            );
                                            invalidCount++;
                                        }
                                    },
                                );

                                this.showMessage(
                                    `验证完成：${validCount} 个有效，${invalidCount} 个无效`,
                                    validCount > 0 ? "success" : "error",
                                );
                            } else {
                                this.showMessage(
                                    "验证失败: " +
                                    (data.message || "未知错误"),
                                    "error",
                                );
                            }
                        } else {
                            const errorData = await response.json();
                            this.showMessage(
                                "验证失败: " +
                                (errorData.message || "网络错误"),
                                "error",
                            );
                        }
                    } catch (error) {
                        this.showMessage(
                            "验证失败: " + error.message,
                            "error",
                        );
                    } finally {
                        this.validatingKeys = false;
                    }
                },

                // 清空所有密钥
                clearAllKeys() {
                    if (this.groupFormData.api_keys.filter(k => k.trim()).length === 0) {
                        this.showMessage("没有密钥需要清空", "info");
                        return;
                    }

                    if (!confirm("确定要清空所有密钥吗？此操作不可恢复。")) {
                        return;
                    }

                    // 清空所有密钥，只保留一个空项
                    this.groupFormData.api_keys = [""];

                    // 清除选中状态和验证状态
                    this.selectedKeys = [];
                    this.keyValidationStatus = {};
                    this.invalidKeyIndexes = [];

                    // 重置页码
                    this.keyPage = 1;

                    this.showMessage("已清空所有密钥", "success");
                },

                // 导出密钥
                exportKeys() {
                    const validKeys = this.groupFormData.api_keys.filter(k => k.trim());

                    if (validKeys.length === 0) {
                        this.showMessage("没有密钥可以导出", "info");
                        return;
                    }

                    try {
                        // 创建文件内容，每行一个密钥
                        const content = validKeys.join('\n');

                        // 生成文件名
                        const groupName = this.groupFormData.name || this.groupFormData.group_id || 'group';
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                        const filename = `${groupName}_api_keys_${timestamp}.txt`;

                        // 创建并下载文件
                        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        this.showMessage(`已导出 ${validKeys.length} 个密钥到文件 ${filename}`, "success");
                    } catch (error) {
                        console.error('导出密钥失败:', error);
                        this.showMessage("导出密钥失败: " + error.message, "error");
                    }
                },

                // 强制设置密钥状态
                async forceSetKeyStatus(keyIndex, status) {
                    const apiKey = this.groupFormData.api_keys[keyIndex];
                    if (!apiKey || !apiKey.trim()) {
                        this.showMessage("密钥不能为空", "error");
                        return;
                    }

                    if (!this.editingGroupId) {
                        this.showMessage("只能在编辑模式下强制设置密钥状态", "error");
                        return;
                    }

                    // 设置加载状态
                    this.forcingKeyStatus[keyIndex] = true;
                    this.forcingKeyStatus = { ...this.forcingKeyStatus };

                    try {
                        const response = await fetch(
                            `/admin/groups/${this.editingGroupId}/keys/force-status`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    api_key: apiKey.trim(),
                                    status: status,
                                }),
                            }
                        );

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // 更新本地验证状态
                            this.keyValidationStatus[keyIndex] = status;
                            this.keyValidationStatus = { ...this.keyValidationStatus };

                            // 更新失效密钥索引列表
                            if (status === 'invalid') {
                                if (!this.invalidKeyIndexes.includes(keyIndex)) {
                                    this.invalidKeyIndexes.push(keyIndex);
                                }
                            } else {
                                const invalidIndex = this.invalidKeyIndexes.indexOf(keyIndex);
                                if (invalidIndex > -1) {
                                    this.invalidKeyIndexes.splice(invalidIndex, 1);
                                }
                            }

                            // 刷新服务商状态列表以更新分组列表中的信息
                            await this.loadProviderStatuses();

                            // 重新加载持久化验证状态以更新密钥状态统计
                            await this.loadPersistedValidationStatus(false);

                            this.showMessage(
                                `密钥状态已强制设置为${status === 'valid' ? '有效' : '无效'}`,
                                "success"
                            );
                        } else {
                            throw new Error(result.message || "设置密钥状态失败");
                        }
                    } catch (error) {
                        console.error("强制设置密钥状态失败:", error);
                        this.showMessage(
                            "强制设置密钥状态失败: " + error.message,
                            "error"
                        );
                    } finally {
                        // 清除加载状态
                        this.forcingKeyStatus[keyIndex] = false;
                        this.forcingKeyStatus = { ...this.forcingKeyStatus };
                    }
                },

                // 一键删除失效密钥（从服务器）
                async bulkDeleteInvalidKeysFromServer() {
                    if (!this.editingGroupId) {
                        this.showMessage("只能在编辑模式下删除失效密钥", "error");
                        return;
                    }

                    // 检查本地是否有失效密钥
                    const localInvalidCount = this.getInvalidKeyCount();

                    // 如果本地没有失效密钥，但分组列表显示有失效密钥，提示用户先检测
                    if (localInvalidCount === 0) {
                        const groupKeyStatus = this.keyStatus.groups && this.keyStatus.groups[this.editingGroupId];
                        if (groupKeyStatus && groupKeyStatus.invalid_keys > 0) {
                            this.showMessage(
                                `检测到 ${groupKeyStatus.invalid_keys} 个失效密钥，但本地验证状态未加载。请先点击"验证密钥"按钮检测密钥状态，然后再执行删除操作。`,
                                "error"
                            );
                            return;
                        } else {
                            this.showMessage("没有失效密钥需要删除", "info");
                            return;
                        }
                    }

                    if (!confirm(`确定要删除 ${localInvalidCount} 个失效密钥吗？此操作不可恢复。`)) {
                        return;
                    }

                    this.bulkDeletingInvalidKeys = true;

                    try {
                        const response = await fetch(
                            `/admin/groups/${this.editingGroupId}/keys/invalid`,
                            {
                                method: "DELETE",
                            }
                        );

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // 从本地数组中移除失效密钥
                            const validKeys = [];
                            this.groupFormData.api_keys.forEach((key, index) => {
                                if (key.trim() && this.keyValidationStatus[index] !== 'invalid') {
                                    validKeys.push(key);
                                } else if (!key.trim()) {
                                    // 保留空密钥项
                                    validKeys.push(key);
                                }
                            });

                            // 如果所有密钥都被删除了，至少保留一个空项
                            if (validKeys.filter(k => k.trim()).length === 0) {
                                validKeys.push("");
                            }

                            this.groupFormData.api_keys = validKeys;

                            // 重建验证状态
                            const newValidationStatus = {};
                            const newInvalidIndexes = [];
                            this.groupFormData.api_keys.forEach((key, newIndex) => {
                                // 只保留有效密钥的状态
                                if (key.trim()) {
                                    newValidationStatus[newIndex] = 'valid'; // 假设剩余的都是有效的
                                }
                            });

                            this.keyValidationStatus = newValidationStatus;
                            this.invalidKeyIndexes = newInvalidIndexes;

                            // 重置页码和选中状态
                            this.selectedKeys = [];
                            this.keyPage = 1;

                            // 刷新服务商状态列表以更新分组列表中的信息
                            await this.loadProviderStatuses();

                            // 重新加载持久化验证状态以更新密钥状态统计
                            await this.loadPersistedValidationStatus(false);

                            this.showMessage(
                                `成功删除 ${result.deleted_count} 个失效密钥`,
                                "success"
                            );
                        } else {
                            throw new Error(result.message || "删除失效密钥失败");
                        }
                    } catch (error) {
                        console.error("一键删除失效密钥失败:", error);
                        this.showMessage(
                            "一键删除失效密钥失败: " + error.message,
                            "error"
                        );
                    } finally {
                        this.bulkDeletingInvalidKeys = false;
                    }
                },

                // 获取API密钥验证状态
                async loadKeyValidationStatus(groupId) {
                    if (!groupId) return;

                    try {
                        const response = await fetch(
                            `/admin/keys/validation/${groupId}`,
                        );
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.validation_status) {
                                // 更新密钥验证状态
                                this.keyValidationStatus = {};
                                this.invalidKeyIndexes = [];
                                this.groupFormData.api_keys.forEach(
                                    (key, index) => {
                                        if (
                                            key.trim() &&
                                            data.validation_status[
                                            key.trim()
                                            ]
                                        ) {
                                            const status =
                                                data.validation_status[
                                                key.trim()
                                                ];
                                            if (status.is_valid === true) {
                                                this.keyValidationStatus[
                                                    index
                                                ] = "valid";
                                            } else if (
                                                status.is_valid === false
                                            ) {
                                                this.keyValidationStatus[
                                                    index
                                                ] = "invalid";
                                                this.invalidKeyIndexes.push(
                                                    index,
                                                );
                                            }
                                        }
                                    },
                                );
                            }
                        }
                    } catch (error) {
                        console.error(
                            "Failed to load key validation status:",
                            error,
                        );
                    }
                },

                // 获取密钥验证样式类
                getKeyValidationClass(index) {
                    const status = this.keyValidationStatus[index];
                    if (status === "valid") {
                        return "bg-green-50 border-green-200";
                    } else if (status === "invalid") {
                        return "bg-red-50 border-red-200";
                    } else if (status === "validating") {
                        return "bg-yellow-50 border-yellow-200";
                    }
                    return "";
                },

                // 获取失效密钥数量
                getInvalidKeyCount() {
                    let count = 0;
                    this.groupFormData.api_keys.forEach((key, index) => {
                        if (
                            key.trim() &&
                            this.keyValidationStatus[index] === "invalid"
                        ) {
                            count++;
                        }
                    });
                    return count;
                },

                // 加载可用模型
                async loadAvailableModels() {
                    // 如果是编辑模式，可以直接从现有分组加载模型
                    if (this.showEditGroupModal && this.editingGroupId) {
                        this.loadingModels = true;
                        try {
                            const response = await fetch(
                                `/admin/models/available/${this.editingGroupId}`,
                            );

                            if (response.ok) {
                                const data = await response.json();
                                // 解析响应数据
                                const groupData =
                                    data.data[this.editingGroupId];
                                if (
                                    groupData &&
                                    groupData.models &&
                                    groupData.models.data
                                ) {
                                    this.availableModels =
                                        groupData.models.data;
                                    this.filterModels();
                                    this.showMessage(
                                        `成功加载 ${this.availableModels.length} 个模型`,
                                        "success",
                                    );
                                } else {
                                    this.availableModels = [];
                                    this.filterModels();
                                    this.showMessage(
                                        "未找到可用模型",
                                        "error",
                                    );
                                }
                            } else {
                                const errorData = await response.json();
                                this.showMessage(
                                    "加载模型失败: " +
                                    (errorData.error?.message ||
                                        "未知错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            this.showMessage(
                                "网络错误: " + error.message,
                                "error",
                            );
                        } finally {
                            this.loadingModels = false;
                        }
                        return;
                    }

                    // 创建模式需要先验证配置
                    if (
                        !this.groupFormData.provider_type ||
                        !this.groupFormData.base_url
                    ) {
                        this.showMessage(
                            "请先填写服务商类型和Base URL",
                            "error",
                        );
                        return;
                    }

                    const validKeys = this.groupFormData.api_keys.filter(
                        (key) => key.trim().length > 0,
                    );
                    if (validKeys.length === 0) {
                        this.showMessage(
                            "请先添加至少一个API密钥",
                            "error",
                        );
                        return;
                    }

                    this.loadingModels = true;
                    try {
                        // 在获取模型之前，先解析JSON请求头（如果有的话）
                        let parsedHeaders = {};
                        if (this.headersText && this.headersText.trim()) {
                            try {
                                parsedHeaders = JSON.parse(this.headersText.trim());
                            } catch (e) {
                                this.showMessage(
                                    "JSON请求头格式错误: " + e.message,
                                    "error",
                                );
                                this.loadingModels = false;
                                return;
                            }
                        }

                        // 创建临时分组配置来测试模型加载
                        const tempGroupData = {
                            name: this.groupFormData.name || "temp",
                            provider_type: this.groupFormData.provider_type,
                            base_url: this.groupFormData.base_url,
                            enabled: true,
                            timeout: this.groupFormData.timeout || 30,
                            max_retries:
                                this.groupFormData.max_retries || 3,
                            rotation_strategy:
                                this.groupFormData.rotation_strategy ||
                                "round_robin",
                            api_keys: validKeys,
                        };

                        // 使用新的按类型加载模型API
                        const requestData = {
                            provider_type: tempGroupData.provider_type,
                            base_url: tempGroupData.base_url,
                            api_keys: tempGroupData.api_keys,
                            timeout_seconds: tempGroupData.timeout,
                            max_retries: tempGroupData.max_retries,
                            headers: parsedHeaders,
                        };
                        
                        const response = await fetch(
                            "/admin/models/available/by-type",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(requestData),
                            },
                        );

                        if (response.ok) {
                            const data = await response.json();
                            // 解析新API的响应格式
                            const groupData = data.data["temp-group"];
                            if (
                                groupData &&
                                groupData.models &&
                                groupData.models.data
                            ) {
                                this.availableModels =
                                    groupData.models.data;
                                this.filterModels();
                                
                                // 如果modelsText有内容，同步到groupFormData.models以便自动勾选
                                if (this.modelsText && this.modelsText.trim()) {
                                    this.syncTextToModels();
                                }
                                
                                this.showMessage(
                                    `成功加载 ${this.availableModels.length} 个模型`,
                                    "success",
                                );
                            } else {
                                this.availableModels = [];
                                this.filterModels();
                                this.showMessage("未找到可用模型", "error");
                            }
                        } else {
                            const errorData = await response.json();
                            this.showMessage(
                                "加载模型失败: " +
                                (errorData.error || "未知错误"),
                                "error",
                            );
                        }
                    } catch (error) {
                        this.showMessage(
                            "网络错误: " + error.message,
                            "error",
                        );
                    } finally {
                        this.loadingModels = false;
                    }
                },

                // 筛选模型
                filterModels() {
                    if (!this.modelSearchQuery.trim()) {
                        this.filteredModels = this.availableModels;
                    } else {
                        const query = this.modelSearchQuery.toLowerCase();
                        this.filteredModels = this.availableModels.filter(
                            (model) =>
                                model.id.toLowerCase().includes(query) ||
                                (model.owned_by &&
                                    model.owned_by
                                        .toLowerCase()
                                        .includes(query)),
                        );
                    }
                },

                // 清除模型搜索
                clearModelSearch() {
                    this.modelSearchQuery = "";
                    this.filterModels();
                },

                // 全选模型
                selectAllModels() {
                    this.groupFormData.models = this.filteredModels.map(
                        (model) => model.id,
                    );
                },

                // 清空模型选择
                clearAllModels() {
                    this.groupFormData.models = [];
                    this.modelsText = "";
                },

                // 移除单个模型
                removeModel(modelId) {
                    this.groupFormData.models =
                        this.groupFormData.models.filter(
                            (id) => id !== modelId,
                        );
                    // 同步到文本框
                    this.syncModelsToText();
                },

                // 将预选模型列表同步到文本框
                syncModelsToText() {
                    this.modelsText = this.groupFormData.models.join('\n');
                },

                // 将文本框内容同步到预选模型列表
                syncTextToModels() {
                    const textModels = this.modelsText
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                    this.groupFormData.models = [...new Set(textModels)];
                },

                // 验证JSON请求参数格式
                validateRequestParams() {
                    if (!this.requestParamsText.trim()) {
                        this.requestParamsValidationMessage = "";
                        this.requestParamsValidationError = false;
                        return;
                    }

                    try {
                        const parsed = JSON.parse(
                            this.requestParamsText.trim(),
                        );

                        // 检查是否是对象
                        if (
                            typeof parsed !== "object" ||
                            Array.isArray(parsed) ||
                            parsed === null
                        ) {
                            this.requestParamsValidationMessage =
                                "JSON必须是一个对象";
                            this.requestParamsValidationError = true;
                            return;
                        }

                        // 检查支持的参数
                        const supportedParams = [
                            "temperature",
                            "max_tokens",
                            "top_p",
                            "stop",
                        ];
                        const unsupportedParams = Object.keys(
                            parsed,
                        ).filter((key) => !supportedParams.includes(key));

                        if (unsupportedParams.length > 0) {
                            this.requestParamsValidationMessage = `不支持的参数: ${unsupportedParams.join(", ")}。支持的参数: ${supportedParams.join(", ")}`;
                            this.requestParamsValidationError = true;
                            return;
                        }

                        // 验证参数值类型
                        if (
                            "temperature" in parsed &&
                            (typeof parsed.temperature !== "number" ||
                                parsed.temperature < 0 ||
                                parsed.temperature > 2)
                        ) {
                            this.requestParamsValidationMessage =
                                "temperature必须是0-2之间的数字";
                            this.requestParamsValidationError = true;
                            return;
                        }

                        if (
                            "max_tokens" in parsed &&
                            (!Number.isInteger(parsed.max_tokens) ||
                                parsed.max_tokens <= 0)
                        ) {
                            this.requestParamsValidationMessage =
                                "max_tokens必须是正整数";
                            this.requestParamsValidationError = true;
                            return;
                        }

                        if (
                            "top_p" in parsed &&
                            (typeof parsed.top_p !== "number" ||
                                parsed.top_p < 0 ||
                                parsed.top_p > 1)
                        ) {
                            this.requestParamsValidationMessage =
                                "top_p必须是0-1之间的数字";
                            this.requestParamsValidationError = true;
                            return;
                        }

                        if (
                            "stop" in parsed &&
                            !Array.isArray(parsed.stop)
                        ) {
                            this.requestParamsValidationMessage =
                                "stop必须是字符串数组";
                            this.requestParamsValidationError = true;
                            return;
                        }

                        this.requestParamsValidationMessage =
                            "JSON格式正确";
                        this.requestParamsValidationError = false;
                    } catch (e) {
                        this.requestParamsValidationMessage =
                            "JSON格式错误: " + e.message;
                        this.requestParamsValidationError = true;
                    }
                },
                // 验证JSON请求头格式
                validateHeaders() {
                    if (!this.headersText.trim()) {
                        this.headersValidationMessage = "";
                        this.headersValidationError = false;
                        return;
                    }
                    try {
                        const parsed = JSON.parse(
                            this.headersText.trim(),
                        );
                        // 检查是否是对象
                        if (
                            typeof parsed !== "object" ||
                            Array.isArray(parsed) ||
                            parsed === null
                        ) {
                            this.headersValidationMessage =
                                "JSON必须是一个对象";
                            this.headersValidationError = true;
                            return;
                        }
                        // 检查所有值是否为字符串
                        for (const [key, value] of Object.entries(parsed)) {
                            if (typeof value !== "string") {
                                this.headersValidationMessage = 
                                    `请求头 "${key}" 的值必须是字符串`;
                                this.headersValidationError = true;
                                return;
                            }
                        }
                        this.headersValidationMessage =
                            "JSON格式正确";
                        this.headersValidationError = false;
                    } catch (e) {
                        this.headersValidationMessage =
                            "JSON格式错误: " + e.message;
                        this.headersValidationError = true;
                    }
                },

                // 添加模型映射
                addModelMapping() {
                    this.modelMappings.push({ alias: "", original: "" });
                },

                // 移除模型映射
                removeModelMapping(index) {
                    this.modelMappings.splice(index, 1);
                },

                // 根据实际模型名称相似度从现有别名中自动选择
                suggestAliasFromSimilarity(mapping) {
                    if (!mapping.original || mapping.alias || !this.allConfiguredAliases || this.allConfiguredAliases.length === 0) {
                        return; // 如果没有选择模型、已经有别名、或没有可用的别名列表，不做推荐
                    }

                    const modelName = mapping.original.toLowerCase();
                    let bestMatch = '';
                    let highestSimilarity = 0;

                    // 遍历所有已配置的别名，找到相似度最高的
                    for (const alias of this.allConfiguredAliases) {
                        const similarity = this.calculateSimilarity(modelName, alias.toLowerCase());
                        if (similarity > highestSimilarity && similarity > 0.3) { // 只有相似度超过30%才考虑
                            highestSimilarity = similarity;
                            bestMatch = alias;
                        }
                    }

                    // 如果找到了相似度较高的别名，自动设置
                    if (bestMatch && highestSimilarity > 0.3) {
                        mapping.alias = bestMatch;
                        console.log(`为模型 "${mapping.original}" 自动选择了相似别名 "${bestMatch}"，相似度: ${(highestSimilarity * 100).toFixed(1)}%`);
                    }
                },

                // 计算两个字符串的相似度（基于分段匹配）
                calculateSimilarity(str1, str2) {
                    // 如果完全相同，返回1
                    if (str1 === str2) return 1;

                    // 按 - 分割成段
                    const parts1 = str1.split('-').filter(part => part.length > 0);
                    const parts2 = str2.split('-').filter(part => part.length > 0);

                    if (parts1.length === 0 || parts2.length === 0) {
                        return 0;
                    }

                    // 计算匹配的段数
                    let matchedParts = 0;
                    let totalWeight = 0;

                    // 为每个段分配权重（前面的段权重更高）
                    for (let i = 0; i < parts1.length; i++) {
                        const part1 = parts1[i];
                        const weight = Math.max(1, parts1.length - i); // 前面的段权重更高
                        totalWeight += weight;

                        // 检查是否在第二个字符串的段中找到匹配
                        let bestMatch = 0;
                        for (let j = 0; j < parts2.length; j++) {
                            const part2 = parts2[j];
                            
                            // 完全匹配
                            if (part1 === part2) {
                                bestMatch = 1;
                                break;
                            }
                            
                            // 包含关系（较长包含较短的）
                            if (part1.includes(part2) || part2.includes(part1)) {
                                const longer = part1.length > part2.length ? part1 : part2;
                                const shorter = part1.length <= part2.length ? part1 : part2;
                                bestMatch = Math.max(bestMatch, shorter.length / longer.length * 0.8);
                            }
                            
                            // 如果都是数字版本号，进行版本比较
                            if (this.isVersionNumber(part1) && this.isVersionNumber(part2)) {
                                bestMatch = Math.max(bestMatch, 0.3); // 版本号有一定相似度但不高
                            }
                        }

                        matchedParts += bestMatch * weight;
                    }

                    // 计算相似度
                    const similarity = totalWeight > 0 ? matchedParts / totalWeight : 0;

                    // 如果第一个段（通常是主要模型名）不匹配，大幅降低相似度
                    if (parts1.length > 0 && parts2.length > 0) {
                        const firstPartMatch = parts1[0] === parts2[0] || 
                                             parts1[0].includes(parts2[0]) || 
                                             parts2[0].includes(parts1[0]);
                        if (!firstPartMatch) {
                            return similarity * 0.3; // 大幅降低相似度
                        }
                    }

                    return similarity;
                },

                // 判断字符串是否是版本号
                isVersionNumber(str) {
                    // 匹配版本号格式：数字、点、日期等
                    return /^[\d\.]+$/.test(str) || /^\d{4}-\d{2}-\d{2}$/.test(str) || /^v?\d+(\.\d+)*/.test(str);
                },

                // 检查是否是重复的别名
                isDuplicateAlias(alias, currentIndex) {
                    if (!alias || !alias.trim()) {
                        return false;
                    }

                    const trimmedAlias = alias.trim();
                    let count = 0;

                    for (let i = 0; i < this.modelMappings.length; i++) {
                        if (this.modelMappings[i].alias &&
                            this.modelMappings[i].alias.trim() === trimmedAlias) {
                            count++;
                            if (count > 1 && i !== currentIndex) {
                                return true;
                            }
                        }
                    }

                    return false;
                },

                // 获取重复别名的CSS类
                getDuplicateAliasClass(alias, currentIndex) {
                    const baseClass = "w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1";

                    if (this.isDuplicateAlias(alias, currentIndex)) {
                        return baseClass + " border-orange-300 focus:ring-orange-500 bg-orange-50";
                    } else {
                        return baseClass + " border-gray-300 focus:ring-blue-500";
                    }
                },

                // 验证粘贴的模型映射JSON
                validatePasteModelMapping() {
                    if (!this.pasteModelMappingText.trim()) {
                        this.pasteModelMappingValidationMessage = '';
                        this.pasteModelMappingValidationError = false;
                        return;
                    }

                    try {
                        const parsed = JSON.parse(this.pasteModelMappingText.trim());

                        if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
                            this.pasteModelMappingValidationMessage = '请输入有效的JSON对象格式';
                            this.pasteModelMappingValidationError = true;
                            return;
                        }

                        const entries = Object.entries(parsed);
                        if (entries.length === 0) {
                            this.pasteModelMappingValidationMessage = 'JSON对象不能为空';
                            this.pasteModelMappingValidationError = true;
                            return;
                        }

                        // 验证每个键值对
                        for (const [key, value] of entries) {
                            if (typeof key !== 'string' || key.trim() === '') {
                                this.pasteModelMappingValidationMessage = '所有键必须是非空字符串';
                                this.pasteModelMappingValidationError = true;
                                return;
                            }
                            if (typeof value !== 'string' || value.trim() === '') {
                                this.pasteModelMappingValidationMessage = '所有值必须是非空字符串';
                                this.pasteModelMappingValidationError = true;
                                return;
                            }
                        }

                        this.pasteModelMappingValidationMessage = `JSON格式正确，将添加 ${entries.length} 个模型映射`;
                        this.pasteModelMappingValidationError = false;
                    } catch (error) {
                        this.pasteModelMappingValidationMessage = `JSON格式错误: ${error.message}`;
                        this.pasteModelMappingValidationError = true;
                    }
                },

                // 关闭粘贴模型映射弹窗
                closePasteModelMappingModal() {
                    this.showPasteModelMappingModal = false;
                    this.pasteModelMappingText = '';
                    this.pasteModelMappingValidationMessage = '';
                    this.pasteModelMappingValidationError = false;
                },

                // 应用粘贴的模型映射
                applyPasteModelMapping() {
                    if (this.pasteModelMappingValidationError || !this.pasteModelMappingText.trim()) {
                        return;
                    }

                    try {
                        const parsed = JSON.parse(this.pasteModelMappingText.trim());
                        const entries = Object.entries(parsed);

                        // 添加到现有的模型映射列表中
                        for (const [alias, original] of entries) {
                            this.modelMappings.push({
                                alias: alias.trim(),
                                original: original.trim()
                            });
                        }

                        // 关闭弹窗
                        this.closePasteModelMappingModal();

                        // 显示成功消息
                        this.showMessage(`成功添加 ${entries.length} 个模型映射配置`, 'success');

                    } catch (error) {
                        this.showMessage(`解析JSON失败: ${error.message}`, 'error');
                    }
                },

                showMessage(msg, type = "success") {
                    this.message = msg;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = "";
                    }, 3000);
                },

                getKeyStatusText(groupId, provider) {
                    const keyStatusData = this.keyStatus.groups[groupId];
                    if (keyStatusData) {
                        return `${keyStatusData.valid_keys}/${keyStatusData.total_keys}`;
                    }
                    return `${provider.available_keys || 0}/${provider.total_keys || 0}`;
                },

                // 获取详细的密钥状态数据
                getKeyStatusData(groupId, provider) {
                    const keyStatusData =
                        this.keyStatus.groups &&
                        this.keyStatus.groups[groupId];

                    if (keyStatusData) {
                        // 如果有检测数据，使用检测结果
                        const valid = keyStatusData.valid_keys || 0;
                        const invalid = keyStatusData.invalid_keys || 0;
                        const total = keyStatusData.total_keys || 0;

                        return {
                            total: total,
                            valid: valid,
                            invalid: invalid,
                            unknown: 0, // 已检测完毕，没有未知状态
                        };
                    } else {
                        // 如果没有检测数据，使用服务商基本信息
                        const total = provider.total_keys || 0;
                        const available = provider.available_keys || 0;

                        return {
                            total: total,
                            valid: available, // 显示可用密钥数作为有效密钥
                            invalid: Math.max(0, total - available), // 计算无效密钥数
                            unknown: 0, // 使用服务商数据，不显示为未知状态
                        };
                    }
                },

                // 移除自动刷新相关方法
                // startAutoRefresh() {
                //     this.stopAutoRefresh();
                //     this.refreshTimer = setInterval(() => {
                //         this.refreshData();
                //     }, this.refreshInterval);
                // },

                // stopAutoRefresh() {
                //     if (this.refreshTimer) {
                //         clearInterval(this.refreshTimer);
                //         this.refreshTimer = null;
                //     }
                // },

                // updateRefreshInterval() {
                //     if (this.autoRefresh) {
                //         this.startAutoRefresh();
                //     }
                // },

                getStatusText(status) {
                    const statusMap = {
                        healthy: "健康",
                        degraded: "降级",
                        unhealthy: "异常",
                    };
                    return statusMap[status] || "未知";
                },

                getProviderTypeClass(type) {
                    const typeClasses = {
                        openai: "bg-blue-100 text-blue-800",
                        gemini: "bg-green-100 text-green-800",
                        anthropic: "bg-purple-100 text-purple-800",
                        azure_openai: "bg-cyan-100 text-cyan-800",
                    };
                    return typeClasses[type] || "bg-gray-100 text-gray-800";
                },

                formatDuration(value) {
                    if (!value) return "--";

                    // 智能检测输入格式：如果值很大（>10^9），则认为是纳秒；否则认为是秒
                    let seconds;
                    if (value > 1000000000) {
                        // 纳秒格式
                        seconds = Math.floor(value / 1000000000);
                    } else {
                        // 秒格式
                        seconds = Math.floor(value);
                    }

                    const days = Math.floor(seconds / 86400);
                    const hours = Math.floor((seconds % 86400) / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);

                    if (days > 0) {
                        return `${days}天 ${hours}小时 ${minutes}分钟`;
                    } else if (hours > 0) {
                        return `${hours}小时 ${minutes}分钟`;
                    } else {
                        return `${minutes}分钟`;
                    }
                },

                formatResponseTime(nanoseconds) {
                    if (!nanoseconds) return "--";
                    const ms = Math.floor(nanoseconds / 1000000);
                    return `${ms}ms`;
                },

                formatDate(dateStr) {
                    if (!dateStr) return "--";
                    return new Date(dateStr).toLocaleString("zh-CN");
                },


                // 启动系统健康状态的定时刷新（只刷新第一排系统信息）
                startSystemHealthRefresh() {
                    // 立即执行一次刷新
                    this.refreshSystemHealthOnly();

                    // 设置定时器，每60秒刷新一次系统健康状态
                    setInterval(() => {
                        this.refreshSystemHealthOnly();
                    }, 60000); // 60秒刷新一次
                },

                // 只刷新系统健康状态（第一排的系统信息）
                async refreshSystemHealthOnly() {
                    try {
                        await this.loadSystemHealth();
                        this.lastUpdate = new Date();
                    } catch (error) {
                        console.error(
                            "Failed to refresh system health:",
                            error,
                        );
                    }
                },

                // 刷新所有数据（手动刷新时使用）
                async refreshSystemData() {
                    try {
                        await Promise.all([
                            this.loadSystemHealth(),
                            this.loadProviderStatuses(),
                        ]);
                        this.lastUpdate = new Date();
                    } catch (error) {
                        console.error(
                            "Failed to refresh system data:",
                            error,
                        );
                    }
                },

                // 刷新代理密钥使用次数（静默刷新，不显示加载状态）
                async refreshProxyKeysOnly() {
                    try {
                        // 如果代理密钥模态框打开，则刷新数据
                        if (this.showProxyKeyModal) {
                            await this.loadProxyKeys();
                        }
                    } catch (error) {
                        console.error(
                            "Failed to refresh proxy keys:",
                            error,
                        );
                    }
                },

                // 手动刷新所有分组的健康检查
                async refreshAllHealth() {
                    this.loadingHealthRefresh = true;
                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch(
                            "/admin/health/refresh",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    'Authorization': `Bearer ${token}`
                                },
                            },
                        );

                        const result = await response.json();

                        if (response.ok) {
                            this.showMessage(
                                "健康检查已启动，请稍等片刻后查看结果",
                                "success",
                            );
                            // 延迟一段时间后刷新数据以显示检查结果
                            setTimeout(async () => {
                                await this.loadProviderStatuses();
                            }, 3000);
                        } else {
                            throw new Error(
                                result.error || "刷新健康检查失败",
                            );
                        }
                    } catch (error) {
                        console.error("刷新健康检查失败:", error);
                        this.showMessage(
                            "刷新健康检查失败: " + error.message,
                            "error",
                        );
                    } finally {
                        this.loadingHealthRefresh = false;
                    }
                },

                // 代理密钥管理方法
                async loadProxyKeys(page = null, search = null, sortBy = null) {
                    try {
                        // 使用传入的参数或当前状态
                        const currentPage =
                            page !== null ? page : this.proxyKeyPage;
                        const currentSearch =
                            search !== null ? search : this.proxyKeySearch;
                        const currentSortBy =
                            sortBy !== null ? sortBy : this.proxyKeySortBy;

                        // 构建查询参数
                        const params = new URLSearchParams({
                            page: currentPage.toString(),
                            page_size: this.proxyKeyPageSize.toString(),
                            sort_by: currentSortBy,
                        });

                        if (currentSearch.trim()) {
                            params.append("search", currentSearch.trim());
                        }

                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch(
                            `/admin/proxy-keys?${params}`,
                            {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            }
                        );
                        const result = await response.json();

                        if (result.success) {
                            this.proxyKeys = result.keys || [];
                            this.proxyKeyPagination =
                                result.pagination || {};
                            this.proxyKeyPage =
                                this.proxyKeyPagination.page || 1;
                            // 更新当前排序状态
                            if (result.sort_by) {
                                this.proxyKeySortBy = result.sort_by;
                            }
                        } else {
                            console.error("加载代理密钥失败:", result);
                        }
                    } catch (error) {
                        console.error("加载代理密钥失败:", error);
                    }
                },

                async generateProxyKey() {
                    if (!this.newProxyKey.name.trim()) {
                        this.showMessage("请输入密钥名称", "error");
                        return;
                    }

                    try {
                        // 准备请求数据
                        const requestData = {
                            name: this.newProxyKey.name,
                            description: this.newProxyKey.description,
                            allowed_groups: this.newProxyKey.allowed_groups,
                        };

                        // 如果有多个分组或空分组（访问所有分组），添加分组选择配置
                        if (
                            this.newProxyKey.allowed_groups.length > 1 ||
                            this.newProxyKey.allowed_groups.length === 0
                        ) {
                            // 转换前端驼峰命名为后端下划线命名
                            requestData.group_selection_config = {
                                strategy: this.newProxyKey.group_selection_config.strategy,
                                group_weights: this.newProxyKey.group_selection_config.group_weights
                            };
                        }

                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch("/admin/proxy-keys", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${token}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(requestData),
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.showMessage(
                                "代理密钥生成成功！",
                                "success",
                            );
                            this.showGenerateProxyKeyForm = false;
                            this.resetProxyKeyForm();
                            await this.loadProxyKeys();
                        } else {
                            this.showMessage(
                                "生成失败: " + (result.error || "未知错误"),
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("生成代理密钥失败:", error);
                        this.showMessage("网络错误，请检查连接", "error");
                    }
                },

                async deleteProxyKey(keyId) {
                    if (
                        !confirm(
                            "确定要删除这个代理密钥吗？删除后无法恢复。",
                        )
                    ) {
                        return;
                    }

                    try {
                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch(
                            `/admin/proxy-keys/${keyId}`,
                            {
                                method: "DELETE",
                                headers: {
                                    "Authorization": `Bearer ${token}`,
                                    "Content-Type": "application/json",
                                },
                            },
                        );

                        const result = await response.json();
                        if (result.success) {
                            this.showMessage(
                                "代理密钥删除成功！",
                                "success",
                            );
                            await this.loadProxyKeys();
                        } else {
                            this.showMessage(
                                "删除失败: " + (result.error || "未知错误"),
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("删除代理密钥失败:", error);
                        this.showMessage("网络错误，请检查连接", "error");
                    }
                },

                resetProxyKeyForm() {
                    this.newProxyKey = {
                        name: "",
                        description: "",
                        allowed_groups: [],
                        group_selection_config: {
                            strategy: "round_robin",
                            group_weights: [],
                        },
                    };
                },

                toggleProxyKeyGroup(groupId, checked) {
                    if (checked) {
                        if (
                            !this.newProxyKey.allowed_groups.includes(
                                groupId,
                            )
                        ) {
                            this.newProxyKey.allowed_groups.push(groupId);

                            // 如果当前策略是权重模式，为新添加的分组添加权重配置
                            if (this.newProxyKey.group_selection_config.strategy === "weighted") {
                                const existingWeight = this.newProxyKey.group_selection_config.group_weights.find(
                                    (w) => w.group_id === groupId
                                );
                                if (!existingWeight) {
                                    this.newProxyKey.group_selection_config.group_weights.push({
                                        group_id: groupId,
                                        weight: 1
                                    });
                                }
                            }
                        }
                    } else {
                        const index =
                            this.newProxyKey.allowed_groups.indexOf(groupId);
                        if (index > -1) {
                            this.newProxyKey.allowed_groups.splice(index, 1);

                            // 移除对应的权重配置
                            const weightIndex = this.newProxyKey.group_selection_config.group_weights.findIndex(
                                (w) => w.group_id === groupId
                            );
                            if (weightIndex > -1) {
                                this.newProxyKey.group_selection_config.group_weights.splice(
                                    weightIndex,
                                    1
                                );
                            }
                        }
                    }
                },

                getGroupName(groupId) {
                    const provider = this.providerStatuses[groupId];
                    return provider ? provider.group_name : groupId;
                },



                // 编辑代理密钥相关方法
                editProxyKey(key) {

                    this.editingProxyKey = {
                        id: key.id,
                        name: key.name,
                        description: key.description || "",
                        is_active: key.is_active !== false, // 默认为true
                        allowed_groups: key.allowed_groups
                            ? [...key.allowed_groups]
                            : [],
                        group_selection_config: key.group_selection_config
                            ? {
                                strategy:
                                    key.group_selection_config.strategy ||
                                    "round_robin",
                                group_weights: key.group_selection_config
                                    .group_weights
                                    ? [
                                        ...key.group_selection_config
                                            .group_weights,
                                    ]
                                    : [],
                            }
                            : {
                                strategy: "round_robin",
                                group_weights: [],
                            },
                    };

                    // 如果当前策略是权重模式，确保所有允许的分组都有权重配置
                    if (this.editingProxyKey.group_selection_config.strategy === "weighted") {
                        this.ensureAllGroupsHaveWeights();
                    }


                    this.showEditProxyKeyModal = true;
                },

                closeEditProxyKeyModal() {
                    this.showEditProxyKeyModal = false;
                    this.editingProxyKey = {
                        id: "",
                        name: "",
                        description: "",
                        is_active: true,
                        allowed_groups: [],
                        group_selection_config: {
                            strategy: "round_robin",
                            group_weights: [],
                        },
                    };
                },

                toggleEditingProxyKeyGroup(groupId, checked) {
                    if (checked) {
                        if (
                            !this.editingProxyKey.allowed_groups.includes(
                                groupId,
                            )
                        ) {
                            this.editingProxyKey.allowed_groups.push(
                                groupId,
                            );
                        }
                    } else {
                        const index =
                            this.editingProxyKey.allowed_groups.indexOf(
                                groupId,
                            );
                        if (index > -1) {
                            this.editingProxyKey.allowed_groups.splice(
                                index,
                                1,
                            );
                        }
                    }

                    // 如果当前策略是权重模式，同步权重配置
                    if (this.editingProxyKey.group_selection_config.strategy === "weighted") {
                        this.ensureAllGroupsHaveWeights();
                    }
                },

                async updateProxyKey() {
                    if (!this.editingProxyKey.name.trim()) {
                        this.showMessage("请输入密钥名称", "error");
                        return;
                    }

                    try {
                        // 如果当前策略是权重模式，确保所有分组都有权重配置
                        if (this.editingProxyKey.group_selection_config.strategy === "weighted") {
                            this.ensureAllGroupsHaveWeights();
                        }

                        // 准备请求数据
                        const requestData = {
                            name: this.editingProxyKey.name,
                            description: this.editingProxyKey.description,
                            is_active: this.editingProxyKey.is_active,
                            allowed_groups:
                                this.editingProxyKey.allowed_groups,
                        };

                        // 如果有多个分组或空分组（访问所有分组），添加分组选择配置
                        if (
                            this.editingProxyKey.allowed_groups.length > 1 ||
                            this.editingProxyKey.allowed_groups.length === 0
                        ) {
                            // 转换前端驼峰命名为后端下划线命名
                            requestData.group_selection_config = {
                                strategy: this.editingProxyKey.group_selection_config.strategy,
                                group_weights: this.editingProxyKey.group_selection_config.group_weights
                            };
                        }



                        const token = localStorage.getItem('authToken');
                        if (!token) {
                            throw new Error("未找到认证令牌");
                        }

                        const response = await fetch(
                            `/admin/proxy-keys/${this.editingProxyKey.id}`,
                            {
                                method: "PUT",
                                headers: {
                                    "Authorization": `Bearer ${token}`,
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(requestData),
                            },
                        );

                        const result = await response.json();

                        if (result.success) {
                            this.showMessage(
                                "代理密钥更新成功！",
                                "success",
                            );
                            this.closeEditProxyKeyModal();

                            // 重新加载数据以确保界面显示最新数据
                            await this.loadProxyKeys();
                        } else {
                            this.showMessage(
                                "更新失败: " + (result.error || "未知错误"),
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("更新代理密钥失败:", error);
                        this.showMessage("网络错误，请检查连接", "error");
                    }
                },

                copyToClipboard(text) {
                    navigator.clipboard
                        .writeText(text)
                        .then(() => {
                            this.showMessage("已复制到剪贴板", "success");
                        })
                        .catch(() => {
                            // 降级方案
                            const textArea =
                                document.createElement("textarea");
                            textArea.value = text;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand("copy");
                            document.body.removeChild(textArea);
                            this.showMessage("已复制到剪贴板", "success");
                        });
                },

                // 代理密钥搜索和分页方法
                async searchProxyKeys() {
                    this.proxyKeyPage = 1; // 搜索时重置到第一页
                    await this.loadProxyKeys(1, this.proxyKeySearch);
                },

                // 更改代理密钥排序方式
                async changeProxyKeySortBy() {
                    this.proxyKeyPage = 1; // 重置到第一页
                    await this.loadProxyKeys();
                },

                async goToProxyKeyPage(page) {
                    if (
                        page >= 1 &&
                        page <= this.proxyKeyPagination.total_pages
                    ) {
                        await this.loadProxyKeys(page);
                    }
                },

                async changeProxyKeyPageSize() {
                    this.proxyKeyPage = 1; // 改变页面大小时重置到第一页
                    await this.loadProxyKeys(1);
                },

                clearProxyKeySearch() {
                    this.proxyKeySearch = "";
                    this.searchProxyKeys();
                },

                viewProviderDetails(groupId) {
                    // 实现查看服务商详情的逻辑
                    alert(`查看服务商 ${groupId} 的详细信息`);
                },

                exportHealthReport() {
                    // 实现导出健康报告的逻辑
                    const report = {
                        timestamp: new Date().toISOString(),
                        system_health: this.systemHealth,
                        provider_statuses: this.providerStatuses,
                    };

                    const blob = new Blob(
                        [JSON.stringify(report, null, 2)],
                        { type: "application/json" },
                    );
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `health_report_${new Date().toISOString().split("T")[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },

                // 分组选择配置相关方法
                getGroupsForWeightConfig(allowed_groups) {
                    // 如果没有选择任何分组，返回所有启用的分组
                    if (allowed_groups.length === 0) {
                        return Object.keys(this.providerStatuses).filter(
                            (groupId) =>
                                this.providerStatuses[groupId] &&
                                this.providerStatuses[groupId].enabled,
                        );
                    }
                    // 否则返回选择的分组
                    return allowed_groups;
                },

                onNewProxyKeyStrategyChange() {
                    const prevStrategy = this._newProxyKeyPrevStrategy || "round_robin";
                    // 保存上一策略的权重快照
                    this.newProxyKeyWeightsSnapshot[prevStrategy] = JSON.parse(JSON.stringify(this.newProxyKey.group_selection_config.group_weights || []));

                    const currentStrategy = this.newProxyKey.group_selection_config.strategy;
                    if (currentStrategy === "weighted" || currentStrategy === "failover") {
                        // 为每个允许的分组初始化权重，优先从快照恢复
                        const groups = this.getGroupsForWeightConfig(this.newProxyKey.allowed_groups);

                        const currentWeights = this.newProxyKey.group_selection_config.group_weights || [];
                        const validWeights = (this.newProxyKey.allowed_groups.length === 0)
                            ? currentWeights
                            : currentWeights.filter(w => this.newProxyKey.allowed_groups.includes(w.group_id));

                        const snapshot = this.newProxyKeyWeightsSnapshot[currentStrategy] || [];

                        this.newProxyKey.group_selection_config.group_weights = groups.map((groupId) => {
                            const snap = snapshot.find(w => w.group_id === groupId);
                            if (snap) {
                                return { group_id: groupId, weight: parseInt(snap.weight) || 1 };
                            }
                            const existingWeight = validWeights.find(w => w.group_id === groupId);
                            return existingWeight || { group_id: groupId, weight: 1 };
                        });
                    }
                    // 更新当前策略为“上一策略”
                    this._newProxyKeyPrevStrategy = currentStrategy;
                },

                onEditingProxyKeyStrategyChange() {
                    const prevStrategy = this._editingProxyKeyPrevStrategy || "round_robin";
                    // 保存上一策略快照
                    this.editingProxyKeyWeightsSnapshot[prevStrategy] = JSON.parse(JSON.stringify(this.editingProxyKey.group_selection_config.group_weights || []));

                    const currentStrategy = this.editingProxyKey.group_selection_config.strategy;
                    if (currentStrategy === "weighted" || currentStrategy === "failover") {
                        const groups = this.getGroupsForWeightConfig(this.editingProxyKey.allowed_groups);

                        const currentWeights = this.editingProxyKey.group_selection_config.group_weights || [];
                        const validWeights = (this.editingProxyKey.allowed_groups.length === 0)
                            ? currentWeights
                            : currentWeights.filter(w => this.editingProxyKey.allowed_groups.includes(w.group_id));

                        const snapshot = this.editingProxyKeyWeightsSnapshot[currentStrategy] || [];

                        this.editingProxyKey.group_selection_config.group_weights = groups.map((groupId) => {
                            const snap = snapshot.find(w => w.group_id === groupId);
                            if (snap) {
                                return { group_id: groupId, weight: parseInt(snap.weight) || 1 };
                            }
                            const existingWeight = validWeights.find(w => w.group_id === groupId);
                            return existingWeight || { group_id: groupId, weight: 1 };
                        });
                    }
                    this._editingProxyKeyPrevStrategy = currentStrategy;
                },

                // 确保所有允许的分组都有权重配置
                ensureAllGroupsHaveWeights() {
                    const groups = this.getGroupsForWeightConfig(
                        this.editingProxyKey.allowed_groups,
                    );

                    // 清理不再属于允许分组的权重配置
                    const currentWeights = this.editingProxyKey.group_selection_config.group_weights || [];
                    const validWeights = (this.editingProxyKey.allowed_groups.length === 0)
                        ? currentWeights // 未选择任何分组=全部分组，保留所有已有权重
                        : currentWeights.filter(w => this.editingProxyKey.allowed_groups.includes(w.group_id));

                    // 为缺少权重配置的分组添加默认权重，保留已有的权重值
                    this.editingProxyKey.group_selection_config.group_weights = groups.map((groupId) => {
                        const existingWeight = validWeights.find(w => w.group_id === groupId);
                        if (existingWeight) {
                            // 返回现有的权重配置，保持用户设置的权重值
                            return existingWeight;
                        } else {
                            // 只为新添加的分组设置默认权重1
                            return {
                                group_id: groupId,
                                weight: 1
                            };
                        }
                    });
                },

                getGroupWeight(groupId) {
                    const weight =
                        this.newProxyKey.group_selection_config.group_weights.find(
                            (w) => w.group_id === groupId,
                        );
                    return weight ? weight.weight : 1;
                },

                setGroupWeight(groupId, weight) {
                    const weightObj =
                        this.newProxyKey.group_selection_config.group_weights.find(
                            (w) => w.group_id === groupId,
                        );
                    if (weightObj) {
                        weightObj.weight = parseInt(weight) || 1;
                    } else {
                        this.newProxyKey.group_selection_config.group_weights.push(
                            {
                                group_id: groupId,
                                weight: parseInt(weight) || 1,
                            },
                        );
                    }
                    // 同步更新当前策略的快照
                    const currentStrategy = this.newProxyKey.group_selection_config.strategy || "round_robin";
                    this.newProxyKeyWeightsSnapshot[currentStrategy] = JSON.parse(JSON.stringify(this.newProxyKey.group_selection_config.group_weights || []));
                },

                getEditingGroupWeight(groupId) {
                    const weight =
                        this.editingProxyKey.group_selection_config.group_weights.find(
                            (w) => w.group_id === groupId,
                        );
                    return weight ? weight.weight : 1;
                },

                setEditingGroupWeight(groupId, weight) {
                    const weightObj =
                        this.editingProxyKey.group_selection_config.group_weights.find(
                            (w) => w.group_id === groupId,
                        );
                    if (weightObj) {
                        weightObj.weight = parseInt(weight) || 1;
                    } else {
                        this.editingProxyKey.group_selection_config.group_weights.push(
                            {
                                group_id: groupId,
                                weight: parseInt(weight) || 1,
                            },
                        );
                    }
                    // 同步更新当前策略的快照
                    const currentStrategyEdit = this.editingProxyKey.group_selection_config.strategy || "round_robin";
                    this.editingProxyKeyWeightsSnapshot[currentStrategyEdit] = JSON.parse(JSON.stringify(this.editingProxyKey.group_selection_config.group_weights || []));
                },

                getStrategyDisplayName(strategy) {
                    const names = {
                        round_robin: "轮询",
                        weighted: "权重",
                        random: "随机",
                        failover: "故障转移",
                    };
                    return names[strategy] || strategy;
                },

                getStrategyBadgeClass(strategy) {
                    const classes = {
                        round_robin: "bg-blue-100 text-blue-800",
                        weighted: "bg-purple-100 text-purple-800",
                        random: "bg-green-100 text-green-800",
                        failover: "bg-orange-100 text-orange-800",
                    };
                    return classes[strategy] || "bg-gray-100 text-gray-800";
                },

                async viewGroupStats(keyId) {
                    try {
                        const response = await fetch(
                            `/admin/proxy-keys/${keyId}/group-stats`,
                        );
                        const result = await response.json();

                        if (result.success) {
                            // 显示统计信息的模态框或弹窗
                            let statsText = "分组使用统计:\n\n";
                            for (const [groupId, stats] of Object.entries(
                                result.stats,
                            )) {
                                statsText += `${this.getGroupName(groupId)}:\n`;
                                statsText += `  使用次数: ${stats.usage_count}\n`;
                                statsText += `  最后使用: ${stats.last_used ? this.formatDate(stats.last_used) : "从未使用"}\n\n`;
                            }
                            alert(statsText);
                        } else {
                            this.showMessage(
                                "获取统计信息失败: " +
                                (result.error || "未知错误"),
                                "error",
                            );
                        }
                    } catch (error) {
                        console.error("获取分组统计失败:", error);
                        this.showMessage("网络错误，请检查连接", "error");
                    }
                },

                viewSystemLogs() {
                    window.location.href = "/logs";
                },

                // 密钥使用统计相关方法
                async showKeyUsageStats(groupId, provider) {
                    this.loadingUsageStats = true;
                    this.currentGroupUsageStats = null;
                    this.showKeyUsageStatsModal = true;

                    try {
                        const response = await fetch(`/admin/groups/${groupId}/keys/usage-stats`);
                        const result = await response.json();

                        if (result.success) {
                            this.currentGroupUsageStats = result;
                        } else {
                            this.showMessage('获取使用统计失败: ' + (result.error || '未知错误'), 'error');
                            this.showKeyUsageStatsModal = false;
                        }
                    } catch (error) {
                        console.error('获取密钥使用统计失败:', error);
                        this.showMessage('网络错误，请检查连接', 'error');
                        this.showKeyUsageStatsModal = false;
                    } finally {
                        this.loadingUsageStats = false;
                    }
                },

                closeKeyUsageStatsModal() {
                    this.showKeyUsageStatsModal = false;
                    this.currentGroupUsageStats = null;
                    this.selectedForceUpdateKey = null;
                },

                async resetGroupUsageStats(groupId) {
                    if (!confirm('确定要重置该分组的所有密钥使用统计吗？此操作不可恢复。')) {
                        return;
                    }

                    try {
                        const response = await fetch(`/admin/groups/${groupId}/keys/reset-stats`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('token')
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.showMessage('使用统计重置成功', 'success');
                            // 重新加载统计数据
                            await this.showKeyUsageStats(groupId);
                        } else {
                            this.showMessage('重置失败: ' + (result.error || '未知错误'), 'error');
                        }
                    } catch (error) {
                        console.error('重置使用统计失败:', error);
                        this.showMessage('网络错误，请检查连接', 'error');
                    }
                },

                openForceUpdateModal(keyStats) {
                    this.selectedForceUpdateKey = {
                        api_key_prefix: keyStats.api_key_prefix,
                        api_key_hash: keyStats.api_key_hash,
                        current_status: keyStats.is_available ? 'valid' : 'invalid'
                    };
                    this.forceUpdateStatus = keyStats.is_available ? 'invalid' : 'valid'; // 默认切换状态
                    this.showForceUpdateModal = true;
                },

                closeForceUpdateModal() {
                    this.showForceUpdateModal = false;
                    this.selectedForceUpdateKey = null;
                    this.forceUpdateStatus = 'valid';
                },

                async submitForceUpdate() {
                    if (!this.selectedForceUpdateKey || !this.currentGroupUsageStats) {
                        return;
                    }

                    // 使用密钥哈希进行更新，安全且不暴露完整密钥
                    const requestData = {
                        api_key: this.selectedForceUpdateKey.api_key_hash, // 使用哈希值而不是完整密钥
                        status: this.forceUpdateStatus
                    };

                    try {
                        const response = await fetch(`/admin/groups/${this.currentGroupUsageStats.group_id}/keys/force-status`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('token')
                            },
                            body: JSON.stringify(requestData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.showMessage('密钥状态更新成功', 'success');
                            this.closeForceUpdateModal();
                            // 重新加载统计数据
                            await this.showKeyUsageStats(this.currentGroupUsageStats.group_id);
                        } else {
                            this.showMessage('更新失败: ' + (result.error || '未知错误'), 'error');
                        }
                    } catch (error) {
                        console.error('强制更新密钥状态失败:', error);
                        this.showMessage('网络错误，请检查连接', 'error');
                    }
                },
            };
        }

        function logout() {
            const token = localStorage.getItem('authToken');

            // 清理本地存储
            localStorage.removeItem('authToken');

            if (token) {
                fetch("/auth/logout", {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                    .then((response) => {
                        window.location.href = "/login";
                    })
                    .catch((error) => {
                        console.error("Logout error:", error);
                        window.location.href = "/login";
                    });
            } else {
                window.location.href = "/login";
            }
        }
    </script>
</body>

</html>